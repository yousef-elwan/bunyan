import{m as u}from"./module.esm-Cm4okMZt.js";import{h}from"./api-2skSE4Ue.js";import{S as o}from"./main-9Qm2jZ7z.js";import{t as a,g as d}from"./helpers-DwlY0Bzp.js";import"./index-xsH4HHeE.js";const c=h();function f(){return{isLoading:!0,allData:[],paginationData:null,currentPage:1,ITEMS_PER_PAGE:10,showAdvancedFilters:!1,isUserModalOpen:!1,selectedUser:null,isActionSheetOpen:!1,selectedUserId:null,userActions:[],filters:{search:"",status:"",blacklist:"",email:"",phone:"",join_date_from:"",join_date_to:""},init(){this.loadUrlParams(),this.fetchUsers(this.currentPage)},async fetchUsers(e=1){this.isLoading=!0,this.currentPage=e;try{const t=new URLSearchParams({page:this.currentPage,perPage:this.ITEMS_PER_PAGE});Object.entries(this.filters).forEach(([r,n])=>{n&&t.append(r,n)});const s=await c.get(`${d("dashboard.users.search")}?${t.toString()}`);this.allData=s.data.data,this.paginationData=s.data.pagination,this.updateUrlParams(),this.renderAll(),this.setupPagination(),this.updatePaginationInfo()}catch(t){console.error("Failed to fetch users:",t);const s=document.querySelector("tbody");s&&(s.innerHTML=`<tr><td colspan="6" class="p-5 text-center text-danger">${a("error_loading")}</td></tr>`);const r=document.getElementById("userCardsContainer");r&&(r.innerHTML=`<div class="p-5 text-center text-danger">${a("error_loading")}</div>`)}finally{this.isLoading=!1}},renderAll(){this.renderTable(),this.renderCards()},renderTable(){const e=document.querySelector("tbody");e&&(e.innerHTML="",!(this.allData.length===0&&!this.isLoading)&&this.allData.forEach(t=>{const s=e.insertRow();s.className="hover:bg-gray-50",s.innerHTML=`
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`}" class="user-avatar" alt="${t.name}">
                            <div>
                                <div class="font-medium text-text-primary">${t.name}</div>
                                <div class="text-sm text-text-secondary">${t.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">${this.getSubscriptionBadge(t)}</td>
                    <td class="p-4"><span class="status-badge ${t.status==="active"?"status-active":"status-inactive"}">${t.status_text}</span></td>
                    <td class="p-4">${this.getBlacklistBadge(t,!0)}</td>
                    <td class="p-4 text-text-secondary">${new Date(t.created_at).toLocaleDateString()}</td>
                    <td class="p-4 text-center">
                        <div x-data="{ dropdownOpen: false }" class="relative">
                            <button @click="dropdownOpen = !dropdownOpen" @click.away="dropdownOpen = false" class="p-2 text-text-secondary hover:text-text-primary rounded-full"><i class="fas fa-ellipsis-h"></i></button>
                            <div x-show="dropdownOpen" x-transition class="absolute z-10 right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 text-left">
                                <a href="#" @click.prevent="openUserModal(${t.id}); dropdownOpen = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${a("view_details")}</a>
                                <a href="#" @click.prevent="promptForStatusChange(${t.id}); dropdownOpen = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${t.status==="active"?a("deactivate_user"):a("activate_user")}</a>
                                <a href="#" @click.prevent="promptForBlacklist(${t.id}); dropdownOpen = false" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${t.is_blacklisted?a("unblacklist_user"):a("blacklist_user")}</a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <a href="#" @click.prevent="deleteUserWithConfirmation(${t.id}); dropdownOpen = false" class="block px-4 py-2 text-sm text-danger hover:bg-red-50">${a("delete_user")}</a>
                            </div>
                        </div>
                    </td>
                `}))},renderCards(){const e=document.getElementById("userCardsContainer");e&&(e.innerHTML="",this.allData.forEach(t=>{const s=document.createElement("div");s.className="flex items-center gap-4 p-4 bg-white border rounded-xl shadow-sm border-border-color",s.innerHTML=`
                    <img src="${t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" alt="${t.name}">
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-text-primary truncate">${t.name}</h3>
                        <p class="text-sm text-text-secondary">${t.email}</p>
                        <div class="flex items-center flex-wrap gap-2 mt-2">
                            <span class="status-badge ${t.status==="active"?"status-active":"status-inactive"}">${t.status_text}</span>
                            ${this.getSubscriptionBadge(t)}
                            ${this.getBlacklistBadge(t,!1)}
                        </div>
                    </div>
                    <button @click="openActionSheet(${t.id})" class="p-2 text-text-secondary hover:text-text-primary -m-2"><i class="fas fa-ellipsis-v"></i></button>
                `,e.appendChild(s)}))},getSubscriptionBadge(e){if(e.subscription_end){const t=e.subscription_status;return`<span class="subscription-badge ${t==="active"?"subscription-active":t==="expired"?"subscription-expired":"subscription-none"}"><i class="fas ${t==="active"?"fa-check-circle":t==="expired"?"fa-exclamation-triangle":"fa-ban"}"></i><span>${new Date(e.subscription_end).toLocaleDateString()}</span></span>`}return`<span class="subscription-badge subscription-none"><i class="fas fa-ban"></i>${a("subscription_none")}</span>`},getBlacklistBadge(e,t=!0){return e.is_blacklisted?`<span class="blacklisted-badge"><i class="fas fa-user-slash"></i>${t?` ${a("blacklisted")}`:""}</span>`:t?`<span class="not-blacklisted">${a("not_blacklisted")}</span>`:""},openActionSheet(e){this.selectedUserId=e;const t=this.allData.find(s=>s.id===e);t&&(this.userActions=[{label:a("view_details"),icon:"fas fa-eye",classes:"hover:bg-gray-200",handler:()=>this.openUserModal(e)},{label:t.status==="active"?a("deactivate_user"):a("activate_user"),icon:"fas fa-power-off",classes:"hover:bg-gray-200",handler:()=>this.promptForStatusChange(e)},{label:t.is_blacklisted?a("unblacklist_user"):a("blacklist_user"),icon:"fas fa-user-slash",classes:"hover:bg-gray-200",handler:()=>this.promptForBlacklist(e)},{label:a("delete_user"),icon:"fas fa-trash",classes:"text-danger hover:bg-red-100",handler:()=>this.deleteUserWithConfirmation(e)}],this.isActionSheetOpen=!0)},async promptForStatusChange(e){var n,l;const t=this.allData.find(i=>i.id===e);if(!t)return;const s=t.status==="active"?"inactive":"active",{value:r}=await o.fire({title:a("confirm_status_change_title"),input:"textarea",inputLabel:a("reason_label"),inputPlaceholder:a("reason_placeholder"),showCancelButton:!0,confirmButtonText:a("confirm_button"),cancelButtonText:a("cancel_button"),inputValidator:i=>{if(!i)return a("reason_required")}});if(r)try{await c.put(d("api.users.update_status",{user:e}),{status:s,reason:r}),await this.fetchUsers(this.currentPage),o.fire({title:a("update_success_title"),text:a("update_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(i){console.error(i),o.fire({title:a("error_title"),text:((l=(n=i.response)==null?void 0:n.data)==null?void 0:l.message)||a("error_occurred"),icon:"error"})}},async promptForBlacklist(e){var n,l;const t=this.allData.find(i=>i.id===e);if(!t)return;const s=t.is_blacklisted?"unblacklist":"blacklist",{value:r}=await o.fire({title:a(`confirm_${s}_title`),input:"textarea",inputLabel:a("reason_label"),inputPlaceholder:a("reason_placeholder"),showCancelButton:!0,confirmButtonText:a("confirm_button"),cancelButtonText:a("cancel_button"),inputValidator:i=>{if(!i&&s==="blacklist")return a("reason_required")}});if(r!==void 0)try{const i=d(`api.users.${s}`,{user:e}),p={reason:r};s==="blacklist"?await c.post(i,p):await c.delete(i,{data:p}),await this.fetchUsers(this.currentPage),o.fire({title:a("update_success_title"),text:a("update_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(i){console.error(i),o.fire({title:a("error_title"),text:((l=(n=i.response)==null?void 0:n.data)==null?void 0:l.message)||a("error_occurred"),icon:"error"})}},deleteUserWithConfirmation(e){o.fire({title:a("confirm_delete_title"),text:a("confirm_delete_text"),icon:"warning",showCancelButton:!0,confirmButtonText:a("confirm_delete_button"),cancelButtonText:a("cancel_button"),confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",reverseButtons:!0}).then(t=>{t.isConfirmed&&this.deleteUser(e)})},async deleteUser(e){var t,s;try{await c.delete(d("dashboard.users.destroy",{user:e}));const r=this.allData.length===1&&this.currentPage>1?this.currentPage-1:this.currentPage;await this.fetchUsers(r),o.fire({title:a("delete_success_title"),text:a("delete_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(r){console.error(r),o.fire({title:a("error_title"),text:((s=(t=r.response)==null?void 0:t.data)==null?void 0:s.message)||a("error_occurred"),icon:"error"})}},async openUserModal(e){this.isUserModalOpen=!0,this.selectedUser=null;try{const t=d("api.users.show",{user:e}),s=await c.get(t);this.selectedUser=s.data.data}catch(t){console.error("Failed to fetch user details:",t),this.isUserModalOpen=!1,o.fire({icon:"error",title:this.translate("error_title"),text:this.translate("error_loading_user_details")})}},applyFilters(){this.fetchUsers(1)},updateUrlParams(){const e=new URLSearchParams(window.location.search);this.currentPage>1?e.set("page",this.currentPage):e.delete("page"),Object.entries(this.filters).forEach(([t,s])=>{s?e.set(t,s):e.delete(t)}),history.replaceState(null,"",`${window.location.pathname}?${e.toString()}`)},loadUrlParams(){const e=new URLSearchParams(window.location.search);this.currentPage=parseInt(e.get("page"))||1,Object.keys(this.filters).forEach(t=>{e.has(t)&&(this.filters[t]=e.get(t))})},setupPagination(){const e=document.getElementById("paginationControls");if(!e||!this.paginationData||!this.paginationData.links){e&&(e.innerHTML="");return}e.innerHTML="",this.paginationData.links.forEach(t=>{const s=document.createElement("button");s.innerHTML=t.label.replace("«",'<i class="fas fa-angle-left"></i>').replace("»",'<i class="fas fa-angle-right"></i>'),s.disabled=!t.url||t.active;const r="px-3 py-1.5 text-sm rounded-md border transition-colors disabled:opacity-50 disabled:cursor-not-allowed",n=t.active?"bg-accent-primary text-white border-accent-primary":"border-border-color hover:bg-page-bg";s.className=`${r} ${n}`,s.addEventListener("click",()=>{t.url&&this.fetchUsers(new URL(t.url).searchParams.get("page"))}),e.appendChild(s)})},updatePaginationInfo(){const e=document.getElementById("paginationInfo");if(!e||!this.paginationData||this.paginationData.total===0){e&&(e.innerHTML="");return}const{from:t,to:s,total:r}=this.paginationData;e.innerHTML=a("pagination_info",{from:t,to:s,total:r})}}}u.data("userManagement",f);
