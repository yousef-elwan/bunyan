import{m as p}from"./module.esm-Cm4okMZt.js";import{t as o,g as c}from"./helpers-DwlY0Bzp.js";import{a as h}from"./index-xsH4HHeE.js";import{S as n}from"./main-9Qm2jZ7z.js";function f(e,s){let t;return function(...a){const r=()=>{clearTimeout(t),e(...a)};clearTimeout(t),t=setTimeout(r,s)}}function m(){return{currentView:"chats",mobileView:"chats",chats:[],chatsPagination:{currentPage:0,lastPage:1,isLoadingMore:!1,perPage:30},userId:null,currentChat:null,topics:[],currentTopic:null,messages:[],messagesPagination:{currentPage:0,lastPage:1,isLoadingMore:!1,perPage:50},newMessage:"",isLoadingMessages:!1,isSendingMessage:!1,showScrollToBottomButton:!1,isSelectionMode:!1,selectedMessages:new Set,echoInstance:null,isTopicClosed:!1,searchQuery:"",async init(){this.userId=parseInt(window.AppConfig.user.id,10),window.addEventListener("popstate",()=>this.handleHashChange()),window.addEventListener("resize",()=>this.handleResize()),this.setupEcho(),await this.handleHashChange(),this.handleResize(),this.$watch("searchQuery",f(()=>this.searchConversations(),300)),this.$watch("newMessage",()=>{this.$nextTick(()=>{const e=this.$refs.messageInput;e&&(e.style.height="auto",e.style.height=`${Math.min(e.scrollHeight,128)}px`)})})},isMobile(){return window.innerWidth<768},handleResize(){this.isMobile()?this.currentTopic?this.mobileView="messages":this.currentChat?this.mobileView="topics":this.mobileView="chats":this.mobileView=""},switchToChatsView(){this.currentView="chats",this.currentChat=null,this.currentTopic=null,this.mobileView="chats",this.chats.length===0&&!this.chatsPagination.isLoadingMore&&this.loadMoreChats(),this.updateURLHash(null,null)},async switchToTopicsView(e){var s;if(e||(e=this.currentChat),!e){this.switchToChatsView();return}((s=this.currentChat)==null?void 0:s.id)===e.id&&this.currentView==="topics"&&this.mobileView==="topics"||(this.currentChat=e,this.currentView="topics",this.currentTopic=null,this.mobileView="topics",await this.loadTopics(e.id),this.updateURLHash(e.id,null))},async loadTopic(e){var s;this.isLoadingMessages||((s=this.currentTopic)==null?void 0:s.id)===e.id||(this.isLoadingMessages=!0,this.currentTopic=e,this.isTopicClosed=e.is_closed,this.isSelectionMode=!1,this.selectedMessages.clear(),this.messages=[],this.messagesPagination={currentPage:0,lastPage:1,isLoadingMore:!1,perPage:50},await this.loadMoreMessagesForCurrentTopic(),e.unread_messages_count>0&&this.markAsReadOptimistically(e),this.leaveCurrentTopicChannel(),this.listenToTopicChannel(),this.updateURLHash(this.currentChat.id,e.id),this.mobileView="messages",this.isLoadingMessages=!1)},async handleHashChange(){const e=new URLSearchParams(window.location.hash.substring(1)),s=parseInt(e.get("chat")),t=parseInt(e.get("topic"));if(!s){this.switchToChatsView();return}this.chats.length===0&&await this.loadMoreChats();const i=this.chats.find(a=>a.id===s);if(i){if(await this.loadTopics(i.id),this.currentChat=i,this.currentView="topics",t){const a=this.topics.find(r=>r.id===t);a&&(this.currentTopic=a,await this.loadMoreMessagesForCurrentTopic(),a.unread_messages_count>0&&this.markAsReadOptimistically(a),this.leaveCurrentTopicChannel(),this.listenToTopicChannel())}}else this.switchToChatsView();this.handleResize()},updateURLHash(e,s){let t="";e&&(t=`chat=${e}`,s&&(t+=`&topic=${s}`));const i=window.location.pathname+(t?"#"+t:"");window.location.href!==i&&history.pushState({chatId:e,topicId:s},"",i)},async loadMoreChats(){if(!(this.chatsPagination.isLoadingMore||this.chatsPagination.currentPage>=this.chatsPagination.lastPage)){this.chatsPagination.isLoadingMore=!0;try{const e=await h.get(c("dashboard.chat.conversations.fetch"),{params:{page:this.chatsPagination.currentPage+1,perPage:this.chatsPagination.perPage,query:this.searchQuery}});this.chats.push(...e.data.data),this.chatsPagination.currentPage=e.data.pagination.current_page,this.chatsPagination.lastPage=e.data.pagination.last_page}catch(e){console.error("Failed to load chats:",e)}finally{this.chatsPagination.isLoadingMore=!1}}},async searchConversations(){this.chats=[],this.chatsPagination={currentPage:0,lastPage:1,isLoadingMore:!1,perPage:30},await this.loadMoreChats()},async loadTopics(e){try{const s=await h.get(c("dashboard.chat.topics.fetch",{conversation:e}));this.topics=s.data.data}catch(s){console.error("Failed to load topics:",s),this.topics=[]}},async loadMoreMessagesForCurrentTopic(){var s;if(!this.currentTopic||this.messagesPagination.isLoadingMore||this.messagesPagination.currentPage>=this.messagesPagination.lastPage)return;this.messagesPagination.isLoadingMore=!0;const e=((s=this.$refs.messagesArea)==null?void 0:s.scrollHeight)||0;try{const t=await h.get(c("dashboard.chat.messages.show",{topic:this.currentTopic.id}),{params:{page:this.messagesPagination.currentPage+1,perPage:this.messagesPagination.perPage}}),i=t.data.data.messages.reverse();this.messages.unshift(...i),this.messagesPagination.currentPage=t.data.pagination.current_page,this.messagesPagination.lastPage=t.data.pagination.last_page,this.$nextTick(()=>{this.messagesPagination.currentPage===1?this.scrollToBottom(!0):this.$refs.messagesArea.scrollTop=this.$refs.messagesArea.scrollHeight-e})}catch(t){console.error("Failed to load messages:",t)}finally{this.messagesPagination.isLoadingMore=!1}},setupEcho(){if(this.echoInstance=window.Echo,!this.echoInstance){console.error("Laravel Echo not found. Real-time features will be disabled.");return}this.echoInstance.private(`App.Models.User.${this.userId}`).listen(".message.sent",e=>this.handleNewMessage(e)).listen(".topic.closed",e=>this.handleTopicStatusChange(e,!0)).listen(".topic.reopened",e=>this.handleTopicStatusChange(e,!1)).listen("topic.created",e=>{this.handleNewTopic(e.topic)})},handleNewTopic(e){var s;((s=this.currentChat)==null?void 0:s.id)===e.conversation_id&&(this.topics.some(t=>t.id===e.id)||this.topics.unshift(e))},listenToTopicChannel(){var e;this.leaveCurrentTopicChannel(),(e=this.currentTopic)!=null&&e.id&&this.echoInstance.private(`topic.${this.currentTopic.id}`).listen(".message.sent",s=>this.handleNewMessage(s,!0)).listen(".messages.read",s=>{s.reader_id!==this.userId&&this.handleMessagesReadByOtherUser()}).listen(".messages.deleted",s=>{s.deleter_id!==this.userId&&this.handleMessagesDeletedByOtherUser(s.message_ids)})},leaveCurrentTopicChannel(){var e;(e=this.currentTopic)!=null&&e.id&&this.echoInstance.leave(`topic.${this.currentTopic.id}`)},handleNewMessage(e){var r;const s=e.topic_id===((r=this.currentTopic)==null?void 0:r.id),t=this.$refs.messagesArea?this.$refs.messagesArea.scrollHeight-this.$refs.messagesArea.scrollTop-this.messagesArea.clientHeight<100:!1;s&&(this.messages.some(l=>l.id===e.id)||(this.messages.push(e),e.user_id!==this.userId&&this.markTopicAsRead(e.topic_id),t&&this.$nextTick(()=>this.scrollToBottom(!0))));const i=this.chats.find(l=>l.id===e.conversation_id);i&&(i.last_message=e,!s&&e.user_id!==this.userId&&(i.unread_messages_count=(i.unread_messages_count||0)+1),this.chats.sort((l,u)=>{var d,g;return new Date(((d=u.last_message)==null?void 0:d.created_at)??0)-new Date(((g=l.last_message)==null?void 0:g.created_at)??0)}));const a=this.topics.find(l=>l.id===e.topic_id);a&&(a.last_message=e,!s&&e.user_id!==this.userId&&(a.unread_messages_count=(a.unread_messages_count||0)+1))},async createTopic(){const e=this.newTopicTitle.trim();if(!(!e||!this.currentChat))try{const s=await h.post(c("dashboard.chat.topics.store",{conversation:this.currentChat.id}),{title:e});this.topics.unshift(s.data.data),this.newTopicTitle=""}catch(s){console.error("Failed to create topic:",s),n.fire("خطأ!","فشل إنشاء الموضوع.","error")}},handleMessagesReadByOtherUser(){this.messages.forEach(e=>{e.user_id===this.userId&&(e.status="read")})},handleMessagesDeletedByOtherUser(e){this.messages=this.messages.filter(s=>!e.includes(s.id))},handleTopicStatusChange(e,s){var i;const t=this.topics.find(a=>a.id===e.topic_id);t&&(t.is_closed=s),((i=this.currentTopic)==null?void 0:i.id)===e.topic_id&&(this.isTopicClosed=s)},markAsReadOptimistically(e){if(!e)return;h.post(c("dashboard.chat.messages.read",{topic:e.id})).catch(console.error);const s=this.chats.find(t=>{var i;return t.id===((i=this.currentChat)==null?void 0:i.id)});s&&e&&(s.unread_messages_count=Math.max(0,(s.unread_messages_count||0)-(e.unread_messages_count||0))),e.unread_messages_count=0},async sendMessage(){const e=this.newMessage.trim();if(!e||this.isSendingMessage||this.isTopicClosed)return;this.isSendingMessage=!0;const s=`temp_${Date.now()}`,t={id:s,message:e,created_at:new Date().toISOString(),user:window.AppConfig.user,user_id:this.userId,status:"sent",temp_id:s};this.messages.push(t),this.newMessage="",this.$nextTick(()=>{this.$refs.messageInput.style.height="auto",this.scrollToBottom()});try{const i=await h.post(c("dashboard.chat.messages.store",{topic:this.currentTopic.id}),{message:e}),a=this.messages.findIndex(r=>r.id===s);a>-1&&this.messages.splice(a,1,{...i.data.data,temp_id:s})}catch(i){console.error("Message send failed:",i);const a=this.messages.findIndex(r=>r.id===s);a>-1&&(this.messages[a].status="failed")}finally{this.isSendingMessage=!1}},async closeTopic(e){await n.fire({title:"هل أنت متأكد؟",text:"سيتم إغلاق هذا الموضوع.",icon:"warning",showCancelButton:!0,confirmButtonText:"نعم, قم بإغلاقه!",cancelButtonText:"إلغاء",confirmButtonColor:"#d33",cancelButtonColor:"#3085d6"}),e&&n.fire({title:o("close_topic_title"),text:o("close_topic_text"),icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:o("close_topic_confirm_button"),cancelButtonText:o("close_topic_cancel_button")}).then(async s=>{if(s.isConfirmed)try{await h.post(c("dashboard.chat.topics.close",{topic:e})),this.handleTopicStatusChange({topic_id:e},!0),n.fire(o("close_topic_success_title"),o("close_topic_success_text"),"success")}catch(t){console.error("Failed to close topic:",t),n.fire(o("close_topic_error_title"),o("close_topic_error_text"),"error")}})},async reopenTopic(e){try{await h.post(c("dashboard.chat.topics.reopen",{topic:e})),this.handleTopicStatusChange({topic_id:e},!1)}catch{n.fire(o("close_topic_error_title"),o("reopen_topic_error_text"),"error")}},async deleteSelectedMessages(){if(this.selectedMessages.size===0)return;const e=Array.from(this.selectedMessages);n.fire({title:o("delete_messages_title"),text:o("delete_messages_text",{count:e.length}),icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:o("delete_messages_confirm_button"),cancelButtonText:o("delete_messages_cancel_button")}).then(async s=>{if(s.isConfirmed)try{this.messages=this.messages.filter(t=>!e.includes(t.id)),this.isSelectionMode=!1,this.selectedMessages.clear(),n.fire(o("delete_messages_success_title"),o("delete_messages_success_text"),"success")}catch(t){console.error("Failed to delete messages:",t),n.fire(o("delete_messages_error_title"),o("delete_messages_error_text"),"error")}})},handleChatsScroll(){const e=this.$refs.chatsList;e.scrollTop+e.clientHeight>=e.scrollHeight-100&&this.loadMoreChats()},handleMessagesScroll(){const e=this.$refs.messagesArea;e&&(e.scrollTop<100&&this.messagesPagination.currentPage<this.messagesPagination.lastPage&&this.loadMoreMessagesForCurrentTopic(),this.checkScrollPosition())},scrollToBottom(e=!1){this.$nextTick(()=>{const s=this.$refs.messagesArea;s&&s.scrollTo({top:s.scrollHeight,behavior:e?"auto":"smooth"})})},checkScrollPosition(){this.$nextTick(()=>{const e=this.$refs.messagesArea;e&&(this.showScrollToBottomButton=e.scrollHeight-e.scrollTop-e.clientHeight>300)})},handleMessageInteraction(e){this.isSelectionMode&&this.toggleMessageSelection(e)},handleMessageContextMenu(e){e.user_id===this.userId&&(event.preventDefault(),this.isSelectionMode=!0,this.selectedMessages.add(e.id))},toggleMessageSelection(e){this.selectedMessages.has(e.id)?this.selectedMessages.delete(e.id):this.selectedMessages.add(e.id),this.selectedMessages.size===0&&(this.isSelectionMode=!1)},formatTime:e=>e?dayjs(e).format("h:mm A"):"",formatTimeAgo:e=>e?dayjs(e).fromNow():"",formatDateSeparator(e){const s=dayjs(e).startOf("day"),t=dayjs().startOf("day");return s.isSame(t)?"Today":s.isSame(t.subtract(1,"day"))?"Yesterday":s.format("DD/MM/YYYY")},shouldShowDateSeparator(e,s){if(s===0)return!0;const t=dayjs(this.messages[s-1].created_at).startOf("day");return!dayjs(e.created_at).startOf("day").isSame(t)},shouldShowMessageHeader(e,s){return s===0||this.shouldShowDateSeparator(e,s)?!0:this.messages[s-1].user.id!==e.user.id}}}p.data("chat",m);
