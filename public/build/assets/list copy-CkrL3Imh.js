import{m as p}from"./module.esm-Cm4okMZt.js";import{h as l}from"./api-2skSE4Ue.js";import{S as o}from"./main-9Qm2jZ7z.js";import{t as s,g as d}from"./helpers-DwlY0Bzp.js";import"./index-xsH4HHeE.js";const h=l();function f(){return{isLoading:!0,currentPage:1,ITEMS_PER_PAGE:5,allData:[],paginationData:null,showAdvancedFilters:!1,isUserModalOpen:!1,selectedUser:null,filters:{search:"",blacklist:"",subscription:"",email:"",phone:"",join_date_from:"",join_date_to:"",subscription_end_from:"",subscription_end_to:""},async init(){const a=[];this.loadUrlParams(),a.push(this.fetchUsers()),await Promise.all(a),this.setupTableEventListeners()},translate:s,async fetchUsers(a=this.currentPage){this.isLoading=!0;const t=document.querySelector("tbody");try{const e={page:a,perPage:this.ITEMS_PER_PAGE,...this.filters};Object.keys(e).forEach(r=>{(e[r]===""||e[r]===null)&&delete e[r]});const i=await h.get(d("dashboard.users.search"),{params:e});this.allData=i.data.data,this.paginationData=i.data.pagination,this.currentPage=a,this.updateUrlParams(),this.renderTableAndCards(),this.setupPagination(),this.updatePaginationInfo()}catch(e){console.error("Failed to fetch users:",e),t&&(t.innerHTML=`<tr><td colspan="9" class="text-center p-5 text-danger">${this.translate("error_loading_users")}</td></tr>`)}finally{this.isLoading=!1}},renderTableAndCards(){const a=document.querySelector("tbody");if(a){if(this.allData.length===0){a.innerHTML=`<tr><td colspan="9" class="p-5 text-center text-gray-500">${this.translate("no_users_found")}</td></tr>`;return}a.innerHTML="",this.allData.forEach(t=>{const e=a.insertRow();e.className="hover:bg-gray-50",e.innerHTML=`
                    <td class="p-3">
                        <img src="${t.avatar||`https://ui-avatars.com/api/?name=${t.name}`}" class="user-avatar" alt="${t.name}">
                    </td>
                    <td class="p-3 font-medium text-text-primary">${t.name}</td>
                    <td class="p-3">${t.email}</td>
                    <td class="p-3">${t.phone||"N/A"}</td>
                    <td class="p-3 text-center">${t.properties_count}</td>
                    <td class="p-3">${new Date(t.created_at).toLocaleDateString()}</td>
                    <td class="p-3">
                        ${t.subscription_end?`<span class="subscription-badge ${t.subscription_status==="active"?"subscription-active":t.subscription_status==="expired"?"subscription-expired":"subscription-none"}">
                                  <i class="fas ${t.subscription_status==="active"?"fa-check-circle":t.subscription_status==="expired"?"fa-exclamation-triangle":"fa-ban"}"></i>
                                  <span>${new Date(t.subscription_end).toLocaleDateString()}</span>
                              </span>`:`<span class="subscription-badge subscription-none">
                                  <i class="fas fa-ban"></i>
                                  ${this.translate("subscription_none")}
                              </span>`}
                    </td>
                    <td class="p-3">
                        ${t.is_blacklisted?`<span class="blacklisted-badge">
                                  <i class="fas fa-user-slash"></i>
                                  ${this.translate("blacklisted")}
                              </span>`:`<span class="text-sm text-text-secondary">
                                  ${this.translate("not_blacklisted")}
                              </span>`}
                    </td>
                    <td class="p-3">
                        <div class="flex items-center gap-3">
                            <button class="text-accent-primary hover:text-opacity-80 view-user-action" data-id="${t.id}" title="${this.translate("view_tooltip")}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-text-primary hover:text-opacity-80 toggle-blacklist-action" data-id="${t.id}" title="${t.is_blacklisted?this.translate("unblacklist_button"):this.translate("blacklist_button")}">
                                <i class="fas ${t.is_blacklisted?"fa-user-check":"fa-user-slash"}"></i>
                            </button>
                            <button class="text-danger hover:text-opacity-80 delete-user-action" data-id="${t.id}" title="${this.translate("delete_tooltip")}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `})}},setupTableEventListeners(){document.querySelector("table").addEventListener("click",a=>{const t=a.target.closest(".view-user-action");if(t){this.openUserModal(t.dataset.id);return}const e=a.target.closest(".toggle-blacklist-action");if(e){const r=this.allData.find(n=>n.id==e.dataset.id);r&&this.toggleBlacklist(r);return}const i=a.target.closest(".delete-user-action");if(i){const r=this.allData.find(n=>n.id==i.dataset.id);r&&this.deleteUser(r)}})},updatePaginationInfo(){const a=document.getElementById("paginationInfo");if(!a||!this.paginationData||this.paginationData.total===0){a&&(a.innerHTML="");return}const{from:t,to:e,total:i}=this.paginationData;a.innerHTML=this.translate("pagination_info",{from:t,to:e,total:i})},setupPagination(){const a=document.getElementById("paginationControls");!a||!this.paginationData||!this.paginationData.links||(a.innerHTML="",this.paginationData.links.forEach(t=>{const e=document.createElement("button");e.innerHTML=t.label.replace("«",'<i class="fas fa-angle-left"></i>').replace("»",'<i class="fas fa-angle-right"></i>'),e.disabled=!t.url||t.active;const i="px-3 py-1.5 text-sm rounded-md border transition-colors disabled:opacity-50 disabled:cursor-not-allowed",r=t.active?"bg-accent-primary text-white border-accent-primary":"border-border-color hover:bg-page-bg";e.className=`${i} ${r}`,e.addEventListener("click",()=>{t.url&&this.fetchUsers(new URL(t.url).searchParams.get("page"))}),a.appendChild(e)}))},updateUrlParams(){const a=new URLSearchParams(window.location.search);this.currentPage>1?a.set("page",this.currentPage):a.delete("page"),Object.entries(this.filters).forEach(([t,e])=>{e?a.set(t,e):a.delete(t)}),history.replaceState(null,"",`${window.location.pathname}?${a.toString()}`)},loadUrlParams(){const a=new URLSearchParams(window.location.search);this.currentPage=parseInt(a.get("page"))||1,Object.keys(this.filters).forEach(t=>{a.has(t)&&(this.filters[t]=a.get(t))})},applyFilters(){this.currentPage=1,this.fetchUsers()},resetFilters(){this.filters={search:"",blacklist:"",subscription:"",email:"",phone:"",join_date_from:"",join_date_to:"",subscription_end_from:"",subscription_end_to:""},this.applyFilters()},async openUserModal(a){this.isUserModalOpen=!0;try{const t=d("api.users.show",{user:a}),e=await l().get(t);this.selectedUser=e.data.data}catch(t){console.error("Failed to fetch user details:",t),o.fire({title:s("error_title")||"Error!",text:s("error_loading_user_details")||"Failed to load user details.",icon:"error"}),this.isUserModalOpen=!1}},toggleBlacklist(a,t){a.stopPropagation();const e=this.allData.find(u=>u.id===t);if(!e)return;const i=e.is_blacklisted?"unblacklist":"blacklist",r=e.is_blacklisted?s("unblacklist_confirm_title"):s("blacklist_confirm_title"),n=e.is_blacklisted?s("unblacklist_confirm_text",{name:e.name}):s("blacklist_confirm_text",{name:e.name});o.fire({title:r,text:n,icon:"warning",showCancelButton:!0,confirmButtonText:s("confirm_button"),cancelButtonText:s("cancel_button"),confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",reverseButtons:!0}).then(async u=>{if(u.isConfirmed)try{const c=d(`api.users.${i}`,{user:e.id});i==="blacklist"?await l().post(c):await l().delete(c),e.is_blacklisted=!e.is_blacklisted,this.renderTableAndCards(),this.fetchUsers(this.currentPage),o.fire(s("success_title"),e.is_blacklisted?s("blacklist_success_text",{name:e.name}):s("unblacklist_success_text",{name:e.name}),"success")}catch(c){console.error(`Failed to ${i} user:`,c),o.fire(s("error_title"),s(`${i}_error_text`),"error")}})},deleteUser(a,t){a.stopPropagation();const e=this.allData.find(i=>i.id===t);e&&o.fire({title:s("delete_confirm_title"),text:s("delete_confirm_text",{name:e.name}),icon:"warning",showCancelButton:!0,confirmButtonText:s("delete_confirm_button"),cancelButtonText:s("cancel_button"),confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",reverseButtons:!0}).then(async i=>{if(i.isConfirmed)try{const r=d("dashboard.users.destroy",{user:e.id});await l().delete(r),this.allData=this.allData.filter(n=>n.id!==e.id),this.renderTableAndCards(),this.updatePaginationInfo(),this.selectedUser&&this.selectedUser.id===e.id&&(this.isUserModalOpen=!1),this.allData.length===1&&this.currentPage>1&&this.currentPage--,this.fetchUsers(this.currentPage),o.fire(s("delete_success_title"),s("delete_success_text"),"success")}catch(r){console.error("Failed to delete user:",r),o.fire(s("error_title"),s("delete_error_text"),"error")}})}}}p.data("userManagement",f);
