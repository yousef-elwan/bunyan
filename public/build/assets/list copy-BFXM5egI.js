import{m as u}from"./module.esm-Cm4okMZt.js";import{T as d}from"./tom-select.complete-KjCaKK0W.js";import{h}from"./api-2skSE4Ue.js";import{t as m,g as a}from"./helpers-DwlY0Bzp.js";import{S as r}from"./main-9Qm2jZ7z.js";import{i as p,f as c}from"./isPast-D4jrojYL.js";import{f,a as l}from"./ar-CDyH6U9d.js";import"./index-xsH4HHeE.js";const n=h();function g(){return{selectedUser:null,history:[],isLoadingHistory:!1,isAddModalOpen:!1,isSubmitting:!1,newSubscription:{package:"",package_name:"",duration_in_days:0,price:0,notes:""},translate:m,init(){this.initializeUserSearch()},initializeUserSearch(){const t=new d("#user-select",{valueField:"id",labelField:"name",searchField:["name","email"],load:(e,s)=>{if(!e.length)return s();n.get(a("users.search"),{params:{q:e}}).then(i=>{console.log("API Response data:",i.data.data),s(i.data.data)}).catch(()=>{console.error("Failed to load users for TomSelect"),s()})},render:{option:(e,s)=>`<div class="flex items-center gap-3 p-2">
                                    <img src="${e.avatar_url||`https://ui-avatars.com/api/?name=${s(e.name)}`}" class="w-8 h-8 rounded-full">
                                    <div>
                                        <div class="font-medium">${s(e.name)}</div>
                                        <div class="text-sm text-gray-500">${s(e.email)}</div>
                                    </div>
                                </div>`,item:(e,s)=>`<div class="flex items-center gap-2">
                                    <img src="${e.avatar_url||`https://ui-avatars.com/api/?name=${s(e.name)}`}" class="w-6 h-6 rounded-full">
                                    <span>${s(e.name)}</span>
                                </div>`},onChange:e=>{if(e){const s=t.options[e];this.selectUser(s)}else this.selectedUser=null,this.history=[]}})},selectUser(t){this.selectedUser=t,this.fetchHistory(t.id)},fetchHistory(t){this.isLoadingHistory=!0,this.history=[],n.get(a("subscriptions.history",{user:t})).then(e=>{this.history=e.data.data,this.history.length>0?this.selectedUser.subscription_end=this.history[0].end_date:this.selectedUser.subscription_end=null}).catch(e=>console.error(e)).finally(()=>this.isLoadingHistory=!1)},addSubscription(){if(!this.newSubscription.package_name){r.fire(this.translate("error"),this.translate("please_select_package"),"error");return}this.isSubmitting=!0;const t=a("subscriptions.store",{user:this.selectedUser.id}),e={package_name:this.newSubscription.package_name,duration_in_days:this.newSubscription.duration_in_days,price:this.newSubscription.price,notes:this.newSubscription.notes};n.post(t,e).then(()=>{r.fire(this.translate("success"),this.translate("subscription_added_successfully"),"success"),this.isAddModalOpen=!1,this.resetForm(),this.fetchHistory(this.selectedUser.id)}).catch(s=>{var i,o;r.fire(this.translate("error"),((o=(i=s.response)==null?void 0:i.data)==null?void 0:o.message)||this.translate("unknown_error"),"error")}).finally(()=>this.isSubmitting=!1)},updateFormFromPackage(){if(!this.newSubscription.package){this.resetForm(!1);return}const t=JSON.parse(this.newSubscription.package);this.newSubscription.package_name=t.name,this.newSubscription.duration_in_days=t.duration},resetForm(t=!0){t&&(this.newSubscription.package=""),this.newSubscription.package_name="",this.newSubscription.duration_in_days=0,this.newSubscription.price=0,this.newSubscription.notes=""},formatDate(t){if(!t)return"N/A";const e=document.documentElement.lang==="ar"?{locale:l}:{};return f(new Date(t),"PPP",e)},getRemainingTime(t){if(!t)return{text:this.translate("no_active_subscription"),classes:"text-text-secondary"};const e=new Date(t),s=document.documentElement.lang==="ar"?{locale:l}:{};return p(e)?{text:this.translate("expired_since")+" "+c(e,{...s,addSuffix:!0}),classes:"text-danger font-medium"}:{text:this.translate("expires")+" "+c(e,{...s,addSuffix:!0}),classes:"text-success font-medium"}}}}u.data("subscriptionManager",g);
