import{m as p}from"./module.esm-Cm4okMZt.js";import{h as f}from"./api-2skSE4Ue.js";import{S as o}from"./main-9Qm2jZ7z.js";import{t as s,g as d}from"./helpers-DwlY0Bzp.js";import{f as m,i as g}from"./isPast-D4jrojYL.js";import{t as u,c as b,f as _,a as x}from"./ar-CDyH6U9d.js";import"./index-xsH4HHeE.js";function v(a,t,e){const i=u(a,e==null?void 0:e.in);return isNaN(t)?b(a,NaN):(i.setDate(i.getDate()+t),i)}function w(a,t,e){const i=+u(a,e==null?void 0:e.in),[r,n]=[+u(t.start,e==null?void 0:e.in),+u(t.end,e==null?void 0:e.in)].sort((c,h)=>c-h);return i>=r&&i<=n}const l=f();function y(){return{isLoading:!0,allData:[],paginationData:null,currentPage:1,ITEMS_PER_PAGE:10,showAdvancedFilters:!1,isUserModalOpen:!1,selectedUser:null,isActionSheetOpen:!1,isActionModalOpen:!1,selectedUserForAction:null,userActions:[],filters:{search:"",is_active:"",is_blacklisted:"",email:"",mobile:"",subscription_start:"",subscription_end:""},init(){this.loadUrlParams(),this.fetchUsers(this.currentPage)},async fetchUsers(a=1){this.isLoading=!0,this.currentPage=a;try{const t=new URLSearchParams({page:this.currentPage,perPage:this.ITEMS_PER_PAGE}),e=[];if(Object.entries(this.filters).forEach(([r,n])=>{if(n===void 0||n==="")return;let c="equals";switch(r){case"search":c="includesString";break;case"email":case"mobile":c="contains";break;case"is_active":case"is_blacklisted":c="equals";break;case"subscription_start":c="greaterThanOrEqualTo",r="subscription_end";break;case"subscription_end":c="lessThanOrEqualTo",r="subscription_end";break;default:c="equals"}e.push({id:r,value:n,filterFns:c})}),e.length>0){console.log(e);const r=btoa(JSON.stringify(e));t.append("filters",r)}const i=await l.get(`${d("dashboard.users.search")}?${t.toString()}`);this.allData=i.data.data,this.paginationData=i.data.pagination,this.updateUrlParams(),this.renderAll(),this.setupPagination(),this.updatePaginationInfo()}catch(t){console.error("Failed to fetch users:",t);const e=document.querySelector("tbody");e&&(e.innerHTML=`<tr><td colspan="6" class="p-5 text-center text-danger">${s("error_loading")}</td></tr>`);const i=document.getElementById("userCardsContainer");i&&(i.innerHTML=`<div class="p-5 text-center text-danger">${s("error_loading")}</div>`)}finally{this.isLoading=!1}},renderAll(){this.renderTable(),this.renderCards()},renderTable(){const a=document.querySelector("tbody");a&&(a.innerHTML="",!(this.allData.length===0&&!this.isLoading)&&this.allData.forEach(t=>{const e=a.insertRow();e.className="hover:bg-gray-50",e.innerHTML=`
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`}" class="user-avatar" alt="${t.name}">
                            <div>
                                <div class="font-medium text-text-primary">${t.name}</div>
                                <div class="text-sm text-text-secondary">${t.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">${this.getSubscriptionBadge(t)}</td>
                    <td class="p-4"><span class="status-badge ${t.is_active?"status-active":"status-inactive"}">${t.is_active_text}</span></td>
                    <td class="p-4">${this.getBlacklistBadge(t,!0)}</td>
                    <td class="p-4 text-text-secondary">${new Date(t.created_at).toLocaleDateString()}</td>
                    <td class="p-4 text-center">
                        <button @click="$dispatch('open-action-modal', ${t.id})" class="p-2 text-text-secondary hover:text-text-primary rounded-full">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </td>
                `}))},renderCards(){const a=document.getElementById("userCardsContainer");a&&(a.innerHTML="",this.allData.forEach(t=>{const e=document.createElement("div");e.className="flex items-center gap-4 p-4 bg-white border rounded-xl shadow-sm border-border-color",e.innerHTML=`
                    <img src="${t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" alt="${t.name}">
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-text-primary truncate">${t.name}</h3>
                        <p class="text-sm text-text-secondary">${t.email}</p>
                        <div class="flex items-center flex-wrap gap-2 mt-2">
                            <span class="status-badge ${t.is_active?"status-active":"status-inactive"}">${t.is_active_text}</span>
                            ${this.getSubscriptionBadge(t)}
                            ${this.getBlacklistBadge(t,!1)}
                        </div>
                    </div>
                    <button @click="$dispatch('open-action-sheet', ${t.id})" class="p-2 text-text-secondary hover:text-text-primary -m-2"><i class="fas fa-ellipsis-v"></i></button>
                `,a.appendChild(e)}))},getSubscriptionBadge(a){if(!a.subscription_end)return`<span class="subscription-badge subscription-none"><i class="fas fa-ban"></i> ${s("subscription_none")}</span>`;const t=new Date(a.subscription_end),e=new Date,i=document.documentElement.lang==="ar"?{locale:x}:{};let r="subscription-active",n="fas fa-check-circle",c=m(t,{...i,addSuffix:!0});return g(t)?(r="subscription-expired",n="fas fa-exclamation-triangle"):w(t,{start:e,end:v(e,7)})&&(r="subscription-expired",n="fas fa-exclamation-circle"),`
                <div class="flex flex-col" title="${_(t,"PPP",i)}">
                    <span class="subscription-badge ${r}">
                        <i class="${n}"></i>
                        <span>${c}</span>
                    </span>
                </div>
            `},getBlacklistBadge(a,t=!0){return a.is_blacklisted?`<span class="blacklisted-badge"><i class="fas fa-user-slash"></i>${t?` ${s("blacklisted")}`:""}</span>`:t?`<span class="not-blacklisted">${s("not_blacklisted")}</span>`:""},openActionModal(a){const t=this.allData.find(e=>e.id===a);t&&(this.selectedUserForAction=t,this.isActionModalOpen=!0)},openActionSheet(a){const t=this.allData.find(e=>e.id===a);t&&(this.userActions=[{label:s("view_tooltip"),icon:"fas fa-eye",classes:"hover:bg-gray-200",handler:()=>this.openUserModal(t.id)},{label:t.is_active?s("deactivate_user"):s("activate_user"),icon:"fas fa-power-off",classes:"hover:bg-gray-200",handler:()=>this.promptForStatusChange(t)},{label:t.is_blacklisted?s("unblacklist_button"):s("blacklist_button"),icon:"fas fa-user-slash",classes:"hover:bg-gray-200",handler:()=>this.promptForBlacklist(t)},{label:s("delete_tooltip"),icon:"fas fa-trash",classes:"text-danger hover:bg-red-100",handler:()=>this.deleteUserWithConfirmation(t.id)}],this.isActionSheetOpen=!0)},async promptForStatusChange(a){var i,r;const t=a.is_active?"inactive":"active",{value:e}=await o.fire({title:s("confirm_status_change_title"),input:"textarea",inputLabel:s("reason_label"),inputPlaceholder:s("reason_placeholder"),showCancelButton:!0,confirmButtonText:s("confirm_button"),cancelButtonText:s("cancel_button"),inputValidator:n=>{if(!n)return s("reason_required")}});if(e)try{await l.put(d("api.users.update_status",{user:a.id}),{is_active:t,is_active_reason:e}),await this.fetchUsers(this.currentPage),o.fire({title:s("update_success_title"),text:s("update_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(n){o.fire({title:s("error_title"),text:((r=(i=n.response)==null?void 0:i.data)==null?void 0:r.message)||s("error_occurred"),icon:"error"})}},async promptForBlacklist(a){var i,r;const t=a.is_blacklisted?"unblacklist":"blacklist",{value:e}=await o.fire({title:s(`confirm_${t}_title`),input:"textarea",inputLabel:s("reason_label"),inputPlaceholder:s("reason_placeholder"),showCancelButton:!0,confirmButtonText:s("confirm_button"),cancelButtonText:s("cancel_button"),inputValidator:n=>{if(!n&&t==="blacklist")return s("reason_required")}});if(e!==void 0)try{const n=d(`api.users.${t}`,{user:a.id}),c={is_blacklist_reason:e};t==="blacklist"?await l.post(n,c):await l.delete(n,{data:c}),await this.fetchUsers(this.currentPage),o.fire({title:s("update_success_title"),text:s("update_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(n){o.fire({title:s("error_title"),text:((r=(i=n.response)==null?void 0:i.data)==null?void 0:r.message)||s("error_occurred"),icon:"error"})}},deleteUserWithConfirmation(a){o.fire({title:s("confirm_delete_title"),text:s("confirm_delete_text"),icon:"warning",showCancelButton:!0,confirmButtonText:s("confirm_delete_button"),cancelButtonText:s("cancel_button"),confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",reverseButtons:!0}).then(t=>{t.isConfirmed&&this.deleteUser(a)})},async deleteUser(a){var t,e;try{await l.delete(d("dashboard.users.destroy",{user:a}));const i=this.allData.length===1&&this.currentPage>1?this.currentPage-1:this.currentPage;await this.fetchUsers(i),o.fire({title:s("delete_success_title"),text:s("delete_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(i){o.fire({title:s("error_title"),text:((e=(t=i.response)==null?void 0:t.data)==null?void 0:e.message)||s("error_occurred"),icon:"error"})}},async openUserModal(a){this.isUserModalOpen=!0,this.selectedUser=null;try{const t=d("api.users.show",{user:a}),e=await l.get(t);this.selectedUser=e.data.data}catch{this.isUserModalOpen=!1,o.fire({icon:"error",title:s("error_title"),text:s("error_loading_user_details")})}},applyFilters(){this.fetchUsers(1)},resetFilters(){this.filters={search:"",is_active:"",is_blacklisted:"",email:"",mobile:"",subscription_start:"",subscription_end:""},this.applyFilters()},updateUrlParams(){const a=new URLSearchParams(window.location.search);this.currentPage>1?a.set("page",this.currentPage):a.delete("page"),Object.entries(this.filters).forEach(([t,e])=>{e?a.set(t,e):a.delete(t)}),history.replaceState(null,"",`${window.location.pathname}?${a.toString()}`)},loadUrlParams(){const a=new URLSearchParams(window.location.search);this.currentPage=parseInt(a.get("page"))||1,Object.keys(this.filters).forEach(t=>{a.has(t)&&(this.filters[t]=a.get(t))})},setupPagination(){const a=document.getElementById("paginationControls");if(!a||!this.paginationData||!this.paginationData.links){a&&(a.innerHTML="");return}a.innerHTML="",this.paginationData.links.forEach(t=>{const e=document.createElement("button");e.innerHTML=t.label.replace("«",'<i class="fas fa-angle-left"></i>').replace("»",'<i class="fas fa-angle-right"></i>'),e.disabled=!t.url||t.active;const i="px-3 py-1.5 text-sm rounded-md border transition-colors disabled:opacity-50 disabled:cursor-not-allowed",r=t.active?"bg-accent-primary text-white border-accent-primary":"border-border-color hover:bg-page-bg";e.className=`${i} ${r}`,e.addEventListener("click",()=>{t.url&&this.fetchUsers(new URL(t.url).searchParams.get("page"))}),a.appendChild(e)})},updatePaginationInfo(){const a=document.getElementById("paginationInfo");if(!a||!this.paginationData||this.paginationData.total===0){a&&(a.innerHTML="");return}const{from:t,to:e,total:i}=this.paginationData;a.innerHTML=s("pagination_info",{from:t,to:e,total:i})}}}p.data("userManagement",y);
