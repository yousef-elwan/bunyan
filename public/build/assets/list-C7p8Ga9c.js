import{m as f}from"./module.esm-Cm4okMZt.js";import{h as g}from"./api-C5g70RCE.js";import{S as p}from"./main-9Qm2jZ7z.js";import{t as r,g as h}from"./helpers-DwlY0Bzp.js";import{f as m,a as _}from"./ar-CDyH6U9d.js";import"./index-xsH4HHeE.js";const u=g();function b(){return{isLoading:!0,allData:[],paginationData:null,currentPage:1,ITEMS_PER_PAGE:5,showAdvancedFilters:!1,isActionSheetOpen:!1,isModalOpen:!1,selectedReport:null,isStatusChanged:!1,report_statuses:[],isModalOpen:!1,selectedReport:null,selectedStatus:null,isSaveDisabled:!0,reportActions:[],filters:{search:"",report_status_id:"",type_id:"",date_from:"",date_to:"",owner_id:""},init(){this.loadUrlParams(),this.fetchReports(this.currentPage)},async fetchReports(t=1){this.isLoading=!0,this.currentPage=t;try{const e=new URLSearchParams({page:this.currentPage,perPage:this.ITEMS_PER_PAGE}),a=[];if(Object.entries(this.filters).forEach(([o,l])=>{if(l===void 0||l==="")return;let i=o,n="equals";switch(o){case"search":n="includesString";break;case"date_from":n="greaterThanOrEqualTo",i="created_at";break;case"date_to":n="lessThanOrEqualTo",i="created_at";break;default:n="equals"}a.push({id:i,value:l,filterFns:n})}),a.length>0){const o=btoa(JSON.stringify(a));e.append("filters",o)}const s=await u.get(`${h("api.reports")}?${e.toString()}`);this.allData=s.data.data,this.paginationData=s.data.pagination,this.updateUrlParams(),this.setupPagination(),this.updatePaginationInfo()}catch(e){console.error("Failed to fetch reports:",e),p.fire({icon:"error",title:r("error_title"),text:r("error_loading_reports")})}finally{this.isLoading=!1}},openActionModal(t){this.selectedReport=t,this.selectedStatus=t.report_status_id,this.isSaveDisabled=!0,this.isModalOpen=!0},openActionSheet(t){this.selectedReport=t,this.reportActions=[{label:r("view_tooltip"),icon:"fas fa-eye",classes:"hover:bg-gray-200",handler:()=>this.openActionModal(t)},{label:r("mark_as_resolved"),icon:"fas fa-check-circle",classes:"text-success hover:bg-green-100",handler:()=>this.updateStatus(t.id,"resolved")},{label:r("mark_as_rejected"),icon:"fas fa-ban",classes:"text-gray-700 hover:bg-gray-100",handler:()=>this.updateStatus(t.id,"rejected")}],this.isActionSheetOpen=!0},openModal(t){this.openActionModal(t)},closeModal(){this.isModalOpen=!1},updateSaveButtonState(){this.selectedReport&&(this.isSaveDisabled=this.selectedStatus===this.selectedReport.report_status_id)},async saveReportChanges(){if(!(!this.selectedReport||this.isSaveDisabled))try{await this.updateStatus(this.selectedReport.id,this.selectedStatus),this.closeModal()}catch(t){console.error("Failed to save changes:",t)}},async saveReportStatus(){if(!(!this.selectedReport||!this.isStatusChanged))try{const t=this.selectedReport.id;await this.updateStatus(t,this.selectedStatus),this.closeModal()}catch(t){console.error("Failed to save report status:",t)}},async updateStatus(t,e){var s,o,l;const a=this.allData.find(i=>i.id===t);if(!(a&&a.status.id===e))try{const i=h("api.reports.update_status",{reportId:t}),n=await u.patch(i,{report_status_id:e}),c=this.allData.findIndex(d=>d.id===t);c!==-1&&(this.allData[c].status.id=e,this.allData[c].status={id:e,name:((s=this.report_statuses.find(d=>d.id==e))==null?void 0:s.name)||e}),p.fire({icon:"success",title:n.data.message||r("update_success_title"),showConfirmButton:!1,timer:1500})}catch(i){console.error("Failed to update report status:",i),p.fire({icon:"error",title:r("error_title"),text:((l=(o=i.response)==null?void 0:o.data)==null?void 0:l.message)||r("error_generic")})}finally{this.isActionSheetOpen=!1}},applyFilters(){this.fetchReports(1)},resetFilters(){this.filters={search:"",report_status_id:"",type_id:"",date_from:"",date_to:"",owner_id:""},this.fetchReports(1)},updateUrlParams(){const t=new URLSearchParams(window.location.search);this.currentPage>1?t.set("page",this.currentPage):t.delete("page"),Object.entries(this.filters).forEach(([e,a])=>{a?t.set(e,a):t.delete(e)}),history.replaceState(null,"",`${window.location.pathname}?${t.toString()}`)},loadUrlParams(){const t=new URLSearchParams(window.location.search);this.currentPage=parseInt(t.get("page"))||1,Object.keys(this.filters).forEach(e=>{t.has(e)&&(this.filters[e]=t.get(e))})},setupPagination(){const t=document.getElementById("paginationControls");if(!t||!this.paginationData||!this.paginationData.links){t&&(t.innerHTML="");return}t.innerHTML="",this.paginationData.links.forEach(e=>{const a=document.createElement("button");a.innerHTML=e.label.replace("«",'<i class="fas fa-angle-left"></i>').replace("»",'<i class="fas fa-angle-right"></i>'),a.disabled=!e.url||e.active;const s="px-3 py-1.5 text-sm rounded-md border transition-colors disabled:opacity-50 disabled:cursor-not-allowed",o=e.active?"bg-accent-primary text-white border-accent-primary":"border-border-color hover:bg-page-bg";a.className=`${s} ${o}`,a.addEventListener("click",()=>{e.url&&this.fetchReports(new URL(e.url).searchParams.get("page"))}),t.appendChild(a)})},updatePaginationInfo(){const t=document.getElementById("paginationInfo");if(!t||!this.paginationData||this.paginationData.total===0){t&&(t.innerHTML="");return}const{from:e,to:a,total:s}=this.paginationData;t.innerHTML=r("pagination_info",{from:e,to:a,total:s})},getReportStatusText(t){return r(`status_${t}`)||t},formatDate(t){const e=document.documentElement.lang==="ar"?{locale:_}:{};return m(new Date(t),"d MMM yyyy",e)},propertyEditUrl(t){return h("dashboard.properties.edit",{propertyId:t})},getReportActionsHtml(t="modal"){if(!this.selectedReport)return"";const e=this.selectedReport.id,a=[{status:"resolved",label:r("mark_as_resolved"),icon:"fa-check-circle",color:"success"},{status:"rejected",label:r("mark_as_rejected"),icon:"fa-ban",color:"gray"}];return t==="modal"?a.map(s=>`<button @click="updateStatus(${e}, '${s.status}')" class="btn-${s.color}">
                        <i class="fas ${s.icon} mr-2"></i> ${s.label}
                    </button>`).join(""):a.map(s=>`<button @click="updateStatus(${e}, '${s.status}')" class="w-full flex items-center gap-4 p-3 text-lg rounded-lg text-left bg-card-bg text-${s.color}-dark">
                        <i class="fas ${s.icon} w-6 text-center"></i>
                        <span>${s.label}</span>
                    </button>`).join("")}}}f.data("reportsManagement",b);
