import{S as v}from"./main-9Qm2jZ7z.js";import{L as M}from"./leaflet-src-nExFev09.js";import{t as o,g as x}from"./helpers-DwlY0Bzp.js";import{h as z}from"./api-2skSE4Ue.js";import"./_commonjsHelpers-CqkleIqs.js";import"./index-xsH4HHeE.js";const H=z();function N(S){var p;document.querySelectorAll(".border-danger").forEach(d=>d.classList.remove("border-danger","focus:border-danger","focus:ring-danger")),document.querySelectorAll(".invalid-feedback").forEach(d=>d.textContent="");for(const[d,E]of Object.entries(S)){let _,y;const C=d.split(".")[0];if(C==="attributes"){const g=(p=d.match(/attributes\.(\d+)\.value/))==null?void 0:p[1];g&&(_=document.getElementById(`custom_attr_${g}`),y=document.getElementById(`attributes_${g}_error`))}else if(C==="locales"){const[g,h,I]=d.split(".");_=document.querySelector(`[name="${I}_${h}"]`),y=document.getElementById(`${I}_${h}_error`)}else _=document.querySelector(`[name="${d}"]`),y=document.getElementById(`${d}_error`);_&&_.classList.add("border-danger","focus:border-danger","focus:ring-danger"),y&&(y.textContent=Array.isArray(E)?E[0]:E)}const L=document.querySelector(".border-danger, .invalid-feedback:not(:empty)");L&&L.scrollIntoView({behavior:"smooth",block:"center"})}function G(){const S=document.getElementById("addPropertyForm");if(!S)return;const L=document.getElementById("propCategory"),p=document.getElementById("customAttributesContainer"),d=document.getElementById("customAttributesSection"),E=document.getElementById("propLatitude"),_=document.getElementById("propLongitude"),y=document.getElementById("propertyLocationMap"),C=document.getElementById("propImagesUpload"),g=document.getElementById("imageGalleryPreviewContainer"),h=document.getElementById("savePropertyBtn"),I=document.getElementById("uploadProgressContainer"),q=document.querySelector("#uploadProgressContainer .progress-bar-fill"),A=document.getElementById("uploadStatusText"),w=document.getElementById("propPrice"),T=document.getElementById("price_clean"),k=document.getElementById("propPriceOnRequest");let $=null,B=null,f=[];w&&T&&(w.addEventListener("input",function(a){let r=a.target.value.replace(/[^\d]/g,"");T.value=r,a.target.value=r?parseInt(r).toLocaleString("en-US"):""}),k&&k.addEventListener("change",function(){if(w.disabled=this.checked,w.required=!this.checked,this.checked){w.value="",T.value="";const a=document.getElementById("price_error");a&&(a.textContent=""),w.classList.remove("border-danger","focus:border-danger","focus:ring-danger")}}));function O(){if(!y)return;const a=36.19948,r=37.162667;$=M.map(y).setView([a,r],7),M.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo($),B=M.marker([a,r],{draggable:!0}).addTo($);const s=(t,i)=>{E&&(E.value=t.toFixed(6)),_&&(_.value=i.toFixed(6))};B.on("dragend",()=>s(B.getLatLng().lat,B.getLatLng().lng)),$.on("click",t=>{B.setLatLng(t.latlng),$.panTo(t.latlng),s(t.latlng.lat,t.latlng.lng)}),s(a,r)}async function R(a){if(!(!p||!d)){p.innerHTML=`<p class="text-text-secondary">${o("js_loading_attributes")}</p>`,d.style.display="block";try{const r=btoa(JSON.stringify([{id:"category_id",value:a,filterFns:"equals"}])),s=`${x("customAttribute")}?filters=${r}`,i=(await H.get(s)).data.data;if(p.innerHTML="",i.length===0){p.innerHTML=`<p class="text-text-secondary col-span-full">${o("js_no_attributes")}</p>`;return}i.forEach(e=>{const n=document.createElement("div"),u=document.createElement("label");if(u.htmlFor=`custom_attr_${e.id}`,u.className="block mb-2 text-sm font-medium text-text-primary",u.textContent=e.name,e.is_required){const m=document.createElement("span");m.className="text-danger",m.textContent=" *",u.appendChild(m)}n.appendChild(u);const c=e.custom_attribute_values;let l;if(e.type==="select"&&c&&c.length>0){if(l=document.createElement("select"),!e.is_required){const m=document.createElement("option");m.value="",m.textContent=o("select_attribute_placeholder",{name:e.name}),l.appendChild(m)}c.forEach(m=>{const F=document.createElement("option");F.value=m.id,F.textContent=m.value,l.appendChild(F)})}else l=document.createElement("input"),l.type=e.type==="number"?"number":"text",e.type==="number"&&(e.min_value!==null&&(l.min=e.min_value),e.max_value!==null&&(l.max=e.max_value));l.id=`custom_attr_${e.id}`,l.name=`attributes[${e.id}][value]`,l.className="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-accent-primary focus:border-accent-primary",e.is_required&&(l.required=!0),n.appendChild(l);const b=document.createElement("input");b.type="hidden",b.name=`attributes[${e.id}][custom_attribute_id]`,b.value=e.id,n.appendChild(b);const P=document.createElement("div");P.className="mt-1 text-sm text-danger invalid-feedback",P.id=`attributes_${e.id}_error`,n.appendChild(P),p.appendChild(n)})}catch(r){console.error("Error fetching custom attributes:",r),p.innerHTML=`<p class="text-danger">${o("js_error_loading_attributes")}</p>`}}}L&&L.addEventListener("change",function(){this.value?R(this.value):(d&&(d.style.display="none"),p&&(p.innerHTML=""))});function j(){if(g){if(g.innerHTML="",f.length===0){g.innerHTML=`<p class="w-full text-sm text-center text-text-secondary">${o("js_no_images_selected")}</p>`;return}f.forEach((a,r)=>{const s=new FileReader,t=document.createElement("div");t.className="relative w-28 h-28 group";const i=document.createElement("img");i.className="object-cover w-full h-full rounded-md border border-border-color",s.onload=n=>i.src=n.target.result,s.readAsDataURL(a),t.appendChild(i);const e=document.createElement("button");e.type="button",e.title=o("button_remove_image"),e.className="absolute top-1 right-1 flex items-center justify-center w-5 h-5 bg-danger rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none",e.innerHTML="Ã—",e.onclick=()=>{f.splice(r,1),j()},t.appendChild(e),g.appendChild(t)})}}function D(a){const r=f.length,s=window.AppConfig.settings.max_images||10,t=(window.AppConfig.settings.max_file_size_mb||2)*1024*1024;if(r+a.length>s){v.fire(o("swal_limit_exceeded_title"),o("swal_limit_exceeded_text",{max:s,current:r}),"warning");return}let i=[],e=[];Array.from(a).forEach(n=>{n.size>t?i.push(n.name):["image/jpeg","image/png","image/gif","image/webp"].includes(n.type)?f.push(n):e.push(n.name)}),e.length>0&&v.fire(o("swal_invalid_type_title"),o("swal_invalid_type_text",{name:`"${e.join(", ")}"`}),"warning"),i.length>0&&v.fire(o("swal_file_too_large_title"),o("swal_file_too_large_text",{files:`"${i.join(", ")}"`}),"warning"),j()}if(C){C.addEventListener("change",r=>{D(r.target.files),r.target.value=""});const a=document.getElementById("image-drop-area");a&&(["dragenter","dragover","dragleave","drop"].forEach(r=>{a.addEventListener(r,s=>{s.preventDefault(),s.stopPropagation()},!1),document.body.addEventListener(r,s=>{s.preventDefault(),s.stopPropagation()},!1)}),["dragenter","dragover"].forEach(r=>a.addEventListener(r,()=>a.classList.add("drag-over"))),["dragleave","drop"].forEach(r=>a.addEventListener(r,()=>a.classList.remove("drag-over"))),a.addEventListener("drop",r=>D(r.dataTransfer.files)))}async function U(a){return f.length===0?{success:!0,message:""}:new Promise((r,s)=>{if(!I)return s(new Error("UI progress element missing."));I.style.display="block",A.textContent=o("js_uploading_status",{count:f.length}),q.style.width="0%";const t=new FormData;f.forEach(n=>t.append("images[]",n,n.name));const i=x("dashboard.properties.images.store",{property:a}),e=new XMLHttpRequest;e.open("POST",i,!0),e.setRequestHeader("X-CSRF-TOKEN",window.AppConfig.csrfToken),e.setRequestHeader("Accept","application/json"),e.upload.onprogress=n=>{if(n.lengthComputable){const u=Math.round(n.loaded*100/n.total);q.style.width=u+"%",A.textContent=o("js_uploading_progress",{percent:u})}},e.onload=function(){q.style.width="100%";try{const n=JSON.parse(e.responseText);if(e.status>=200&&e.status<300)A.textContent=o("js_upload_complete"),r({success:!0,message:n.message||""});else{const u=n.message||(n.errors?Object.values(n.errors).flat().join(" "):"Image upload failed.");s(new Error(u))}}catch{s(new Error(o("js_upload_error_parsing")))}},e.onerror=()=>s(new Error(o("js_upload_error_network"))),e.send(t)})}S.addEventListener("submit",async function(a){var r,s;a.preventDefault(),h.disabled=!0,h.innerHTML=`<i class="fas fa-spinner fa-spin me-2"></i> ${o("button_saving")}`,N({});try{const t=new FormData(this),i={price:t.get("price"),size:t.get("size"),year_built:t.get("year_built")||null,category_id:t.get("category_id"),type_id:t.get("type_id"),floor_id:t.get("floor_id")||null,rooms_count:t.get("rooms_count")||null,price_on_request:t.get("price_on_request")==="true",orientation_id:t.get("orientation_id")||null,city_id:t.get("city_id"),latitude:t.get("latitude"),longitude:t.get("longitude"),available_from:t.get("available_from"),video_url:t.get("video_url"),amenities:Array.from(t.getAll("amenities[]")),attributes:[],locales:[]};i.price_on_request&&(i.price=null),document.querySelectorAll("#customAttributesContainer > div").forEach(c=>{const l=c.querySelector('[name^="attributes["][name$="[value]"]'),b=c.querySelector('[name^="attributes["][name$="[custom_attribute_id]"]');b&&l&&l.value.trim()!==""&&i.attributes.push({custom_attribute_id:b.value,value:l.value})}),window.AppConfig.pageData.locales.forEach(c=>{i.locales.push({locale:c,content:t.get(`content_${c}`),location:t.get(`location_${c}`)})});const n=(await H.post(x("dashboard.properties.store"),i)).data,u=n.data.id;if(f.length>0&&u){h.innerHTML=`<i class="fas fa-spinner fa-spin me-2"></i> ${o("button_uploading_images")}`;try{const c=await U(u);v.fire({icon:"success",title:o("swal_success_title"),text:`${n.message||o("js_create_success_default")} ${c.message||o("js_images_processed")}`,timer:4e3,showConfirmButton:!1}).then(()=>window.location.href=x("dashboard.properties.index"))}catch(c){v.fire({icon:"warning",title:o("js_create_success_img_error"),text:o("js_create_success_img_error_desc",{error:c.message}),showConfirmButton:!0}).then(()=>window.location.href=x("dashboard.properties.index"))}}else v.fire({icon:"success",title:o("swal_success_title"),text:n.message||o("js_create_success_default"),timer:3e3,showConfirmButton:!1}).then(()=>window.location.href=x("dashboard.properties.index"))}catch(t){console.error("Error during form submission:",t),t.response&&t.response.status===422&&N(t.response.data.errors),v.fire({icon:"error",title:o("swal_error_title"),text:((s=(r=t.response)==null?void 0:r.data)==null?void 0:s.message)||o("js_form_error_default")}),h.disabled=!1,h.innerHTML=o("button_save")}}),O(),j()}document.addEventListener("DOMContentLoaded",G);
