import{L as N}from"./leaflet-src-nExFev09.js";import{S as x}from"./main-9Qm2jZ7z.js";import{t as i,g as q}from"./helpers-DwlY0Bzp.js";import{h as W}from"./api-C5g70RCE.js";import"./_commonjsHelpers-CqkleIqs.js";import"./index-xsH4HHeE.js";const G=W();function J(T){var w;document.querySelectorAll(".border-danger").forEach(d=>d.classList.remove("border-danger","focus:border-danger","focus:ring-danger")),document.querySelectorAll(".invalid-feedback").forEach(d=>d.textContent="");for(const[d,p]of Object.entries(T)){let _,y;const I=d.split(".")[0];if(I==="attributes"){const b=(w=d.match(/attributes\.(\d+)\.value/))==null?void 0:w[1];b&&(_=document.getElementById(`custom_attr_${b}`),y=document.getElementById(`attributes_${b}_error`))}else if(I==="locales"){const[b,L,v]=d.split(".");_=document.querySelector(`[name="${v}_${L}"]`),y=document.getElementById(`${v}_${L}_error`)}else _=document.querySelector(`[name="${d}"]`),y=document.getElementById(`${d}_error`);_&&_.classList.add("border-danger","focus:border-danger","focus:ring-danger"),y&&(y.textContent=Array.isArray(p)?p[0]:p)}const m=document.querySelector(".border-danger, .invalid-feedback:not(:empty)");m&&m.scrollIntoView({behavior:"smooth",block:"center"})}document.addEventListener("DOMContentLoaded",function(){const T=document.getElementById("page-data");if(!T){console.error("Critical: Page data element not found.");return}const m=JSON.parse(T.textContent),w=document.getElementById("editPropertyForm");if(!w)return;const d=document.getElementById("propCategory"),p=document.getElementById("customAttributesContainer"),_=document.getElementById("customAttributesSection"),y=document.getElementById("propLatitude"),I=document.getElementById("propLongitude"),b=document.getElementById("propertyLocationMap"),L=document.getElementById("propImagesUpload"),v=document.getElementById("imageGalleryPreviewContainer"),C=document.getElementById("savePropertyBtn"),j=document.getElementById("uploadProgressContainer"),V=document.querySelector("#uploadProgressContainer .progress-bar-fill"),X=document.getElementById("uploadStatusText"),k=document.getElementById("existingImagesGallery"),O=document.getElementById("deleted_images_input"),u=document.getElementById("propPrice"),A=document.getElementById("price_clean"),M=document.getElementById("propPriceOnRequest");let $,S,g=[],B=[];function U(){if(!u||!A)return;let o=u.value.replace(/[^\d]/g,"");A.value=o,u.value=o?parseInt(o).toLocaleString("en-US"):""}u&&A&&(u.addEventListener("input",U),u.value&&U(),M&&(M.addEventListener("change",function(){u.disabled=this.checked,u.required=!this.checked,this.checked&&(u.value="",A.value="")}),M.checked&&(u.disabled=!0,u.required=!1)));function K(){if(!b)return;const o=m.property.latitude||36.19948,n=m.property.longitude||37.162667;$=N.map(b).setView([o,n],13),N.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo($),S=N.marker([o,n],{draggable:!0}).addTo($);const r=(e,l)=>{y&&(y.value=e.toFixed(6)),I&&(I.value=l.toFixed(6))};S.on("dragend",()=>r(S.getLatLng().lat,S.getLatLng().lng)),$.on("click",e=>{S.setLatLng(e.latlng),$.panTo(e.latlng),r(e.latlng.lat,e.latlng.lng)})}async function R(o,n={}){if(!(!p||!_)){p.innerHTML=`<p class="text-text-secondary">${i("js_loading_attributes")}</p>`,_.style.display="block";try{const r=btoa(JSON.stringify([{id:"category_id",value:o,filterFns:"equals"}])),e=`${q("api.customAttribute")}?filters=${r}`,a=(await G.get(e)).data.data;if(p.innerHTML="",!a||a.length===0){p.innerHTML=`<p class="text-text-secondary col-span-full">${i("js_no_attributes")}</p>`;return}a.forEach(t=>{const s=document.createElement("div"),f=document.createElement("label");if(f.htmlFor=`custom_attr_${t.id}`,f.className="block mb-2 text-sm font-medium text-text-primary",f.textContent=t.name,t.is_required){const E=document.createElement("span");E.className="text-danger",E.textContent=" *",f.appendChild(E)}s.appendChild(f);const h=t.custom_attribute_values;let c;t.type==="select"&&h&&h.length>0?(c=document.createElement("select"),t.is_required||c.add(new Option(i("select_attribute_placeholder",{name:t.name}),"")),h.forEach(E=>c.add(new Option(E.value,E.id)))):(c=document.createElement("input"),c.type=t.type==="number"?"number":"text",t.type==="number"&&(t.min_value!==null&&(c.min=t.min_value),t.max_value!==null&&(c.max=t.max_value))),c.id=`custom_attr_${t.id}`,c.name=`attributes[${t.id}][value]`,c.className="block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-accent-primary focus:border-accent-primary",t.is_required&&(c.required=!0);const D=n[t.id.toString()];D&&typeof D.value<"u"&&(c.value=D.value),s.appendChild(c);const P=document.createElement("input");P.type="hidden",P.name=`attributes[${t.id}][custom_attribute_id]`,P.value=t.id,s.appendChild(P);const H=document.createElement("div");H.className="mt-1 text-sm text-danger invalid-feedback",H.id=`attributes_${t.id}_error`,s.appendChild(H),p.appendChild(s)})}catch(r){console.error("Error fetching custom attributes:",r),p.innerHTML=`<p class="text-danger">${i("js_error_loading_attributes")}</p>`}}}d&&(d.addEventListener("change",()=>R(d.value,{})),d.value&&R(d.value,m.property.custom_attributes));function F(){if(v){if(v.innerHTML="",g.length===0){v.innerHTML=`<p class="w-full text-sm text-center text-text-secondary">${i("js_no_new_images")}</p>`;return}g.forEach((o,n)=>{const r=document.createElement("div");r.className="relative w-28 h-28 group";const e=document.createElement("img");e.className="object-cover w-full h-full rounded-md border border-border-color";const l=new FileReader;l.onload=t=>e.src=t.target.result,l.readAsDataURL(o),r.appendChild(e);const a=document.createElement("button");a.type="button",a.title=i("button_remove_image"),a.className="absolute top-1 right-1 flex items-center justify-center w-5 h-5 bg-danger rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none",a.innerHTML="×",a.onclick=()=>{g.splice(n,1),F()},r.appendChild(a),v.appendChild(r)})}}function z(o){const n=g.length,r=k?k.querySelectorAll(".existing-image:not(.marked-for-deletion)").length:0,e=window.AppConfig.settings.max_images,l=(window.AppConfig.settings.max_file_size_mb||2)*1024*1024;if(r+n+o.length>e){x.fire(i("swal_limit_exceeded_title"),i("swal_limit_exceeded_text",{max:e}),"warning");return}let a=[],t=[];Array.from(o).forEach(s=>{s.size>l?a.push(s.name):["image/jpeg","image/png","image/gif","image/webp"].includes(s.type)?g.push(s):t.push(s.name)}),t.length>0&&x.fire(i("swal_invalid_type_title"),i("swal_invalid_type_text",{name:`"${t.join(", ")}"`}),"warning"),a.length>0&&x.fire(i("swal_file_too_large_title"),i("swal_file_too_large_text",{files:`"${a.join(", ")}"`}),"warning"),F()}if(L){L.addEventListener("change",n=>{z(n.target.files),n.target.value=""});const o=document.getElementById("image-drop-area");o&&(["dragenter","dragover","dragleave","drop"].forEach(n=>o.addEventListener(n,r=>{r.preventDefault(),r.stopPropagation()},!1)),["dragenter","dragover"].forEach(n=>o.addEventListener(n,()=>o.classList.add("drag-over"))),["dragleave","drop"].forEach(n=>o.addEventListener(n,()=>o.classList.remove("drag-over"))),o.addEventListener("drop",n=>z(n.dataTransfer.files)))}k&&O&&k.addEventListener("click",function(o){const n=o.target.closest(".remove-existing-image-btn");if(n){const r=n.closest(".existing-image"),e=r.dataset.imageName;if(!e)return;const l=B.indexOf(e);l>-1?(B.splice(l,1),r.classList.remove("marked-for-deletion"),n.classList.remove("undo-delete-btn"),n.innerHTML="×",n.title=i("button_remove_image")):(B.push(e),r.classList.add("marked-for-deletion"),n.classList.add("undo-delete-btn"),n.innerHTML="↺",n.title=i("button_undo_delete")),O.value=B.join(",")}});async function Q(o){return g.length===0?{success:!0,message:""}:new Promise((n,r)=>{if(!j)return r(new Error("UI progress element missing."));j.style.display="block",X.textContent=i("js_uploading_status",{count:g.length});const e=new FormData;g.forEach(t=>e.append("images[]",t));const l=q("api.properties.images.store",{property:o}),a=new XMLHttpRequest;a.open("POST",l,!0),a.setRequestHeader("X-CSRF-TOKEN",window.AppConfig.csrfToken||m.csrf_token),a.setRequestHeader("Accept","application/json"),a.upload.onprogress=t=>{if(t.lengthComputable){const s=Math.round(t.loaded*100/t.total);V.style.width=s+"%"}},a.onload=function(){try{const t=JSON.parse(a.responseText);a.status>=200&&a.status<300?n({success:!0,message:t.message||i("js_upload_success_message")}):r(new Error(t.message||"Image upload failed."))}catch{r(new Error(i("js_upload_error_invalid_response")))}},a.onerror=()=>r(new Error(i("js_upload_error_network"))),a.send(e)})}w.addEventListener("submit",async function(o){var n,r;o.preventDefault(),C.disabled=!0,C.innerHTML=`<i class="fas fa-spinner fa-spin me-2"></i> ${i("button_updating")}`,J({});try{const e=new FormData(this),l={_method:"PUT",size:e.get("size"),year_built:e.get("year_built")||null,type_id:e.get("type_id"),available_from:e.get("available_from"),price:e.get("price"),price_on_request:e.get("price_on_request")==="true",category_id:e.get("category_id"),floor_id:e.get("floor_id")||null,rooms_count:e.get("rooms_count")||null,orientation_id:e.get("orientation_id")||null,city_id:e.get("city_id"),latitude:e.get("latitude"),longitude:e.get("longitude"),video_url:e.get("video_url"),deleted_images:B,amenities:Array.from(e.getAll("amenities[]")),attributes:[],locales:[]};l.price_on_request&&(l.price=null),document.querySelectorAll("#customAttributesContainer > div").forEach(s=>{const f=s.querySelector('[name^="attributes["][name$="[value]"]'),h=s.querySelector('[name^="attributes["][name$="[custom_attribute_id]"]');h&&f&&f.value.trim()!==""&&l.attributes.push({custom_attribute_id:h.value,value:f.value})}),m.locales.forEach(s=>{l.locales.push({locale:s,content:e.get(`content_${s}`),location:e.get(`location_${s}`)})});const a=q("api.properties.update",{property:m.property.id}),t=await G.post(a,l);if(g.length>0){C.innerHTML=`<i class="fas fa-spinner fa-spin me-2"></i> ${i("button_uploading_images")}`;const s=await Q(m.property.id);x.fire({icon:"success",title:i("swal_success_title"),text:`${t.data.message||""} ${s.message||""}`,timer:4e3}).then(()=>window.location.href=q("dashboard.properties.index"))}else x.fire({icon:"success",title:i("swal_success_title"),text:t.data.message,timer:3e3}).then(()=>window.location.href=q("dashboard.properties.index"))}catch(e){console.error("Error during form submission:",e),e.response&&e.response.status===422&&J(e.response.data.errors),x.fire({icon:"error",title:i("swal_error_title"),text:((r=(n=e.response)==null?void 0:n.data)==null?void 0:r.message)||i("js_form_error_default")}),C.disabled=!1,C.innerHTML=i("button_update")}}),K(),F()});
