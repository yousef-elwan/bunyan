import{m as f}from"./module.esm-Cm4okMZt.js";import{h as p}from"./api-2skSE4Ue.js";import{S as c}from"./main-9Qm2jZ7z.js";import{t as s,g as d}from"./helpers-DwlY0Bzp.js";import{t as u,c as m,f as g,i as b,a as _,b as x}from"./ar-BL_Q-Yb7.js";import"./index-xsH4HHeE.js";function v(e,t,a){const i=u(e,a==null?void 0:a.in);return isNaN(t)?m(e,NaN):(i.setDate(i.getDate()+t),i)}function w(e,t,a){const i=+u(e,a==null?void 0:a.in),[r,n]=[+u(t.start,a==null?void 0:a.in),+u(t.end,a==null?void 0:a.in)].sort((o,h)=>o-h);return i>=r&&i<=n}const l=p();function y(){return{isLoading:!0,allData:[],paginationData:null,currentPage:1,ITEMS_PER_PAGE:10,showAdvancedFilters:!1,isUserModalOpen:!1,selectedUser:null,isActionSheetOpen:!1,isActionModalOpen:!1,selectedUserForAction:null,userActions:[],filters:{search:"",status:"",blacklist:"",email:"",mobile:"",join_date_from:"",join_date_to:""},init(){this.loadUrlParams(),this.fetchUsers(this.currentPage)},async fetchUsers(e=1){this.isLoading=!0,this.currentPage=e;try{const t=new URLSearchParams({page:this.currentPage,perPage:this.ITEMS_PER_PAGE});Object.entries(this.filters).forEach(([i,r])=>{r&&t.append(i,r)});const a=await l.get(`${d("dashboard.users.search")}?${t.toString()}`);this.allData=a.data.data,this.paginationData=a.data.pagination,this.updateUrlParams(),this.renderAll(),this.setupPagination(),this.updatePaginationInfo()}catch(t){console.error("Failed to fetch users:",t);const a=document.querySelector("tbody");a&&(a.innerHTML=`<tr><td colspan="6" class="p-5 text-center text-danger">${s("error_loading")}</td></tr>`);const i=document.getElementById("userCardsContainer");i&&(i.innerHTML=`<div class="p-5 text-center text-danger">${s("error_loading")}</div>`)}finally{this.isLoading=!1}},renderAll(){this.renderTable(),this.renderCards()},renderTable(){const e=document.querySelector("tbody");e&&(e.innerHTML="",!(this.allData.length===0&&!this.isLoading)&&this.allData.forEach(t=>{const a=e.insertRow();a.className="hover:bg-gray-50",a.innerHTML=`
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`}" class="user-avatar" alt="${t.name}">
                            <div>
                                <div class="font-medium text-text-primary">${t.name}</div>
                                <div class="text-sm text-text-secondary">${t.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">${this.getSubscriptionBadge(t)}</td>
                    <td class="p-4"><span class="status-badge ${t.status==="active"?"status-active":"status-inactive"}">${t.status_text||t.status}</span></td>
                    <td class="p-4">${this.getBlacklistBadge(t,!0)}</td>
                    <td class="p-4 text-text-secondary">${new Date(t.created_at).toLocaleDateString()}</td>
                    <td class="p-4 text-center">
                        <button @click="$dispatch('open-action-modal', ${t.id})" class="p-2 text-text-secondary hover:text-text-primary rounded-full">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </td>
                `}))},renderCards(){const e=document.getElementById("userCardsContainer");e&&(e.innerHTML="",this.allData.forEach(t=>{const a=document.createElement("div");a.className="flex items-center gap-4 p-4 bg-white border rounded-xl shadow-sm border-border-color",a.innerHTML=`
                    <img src="${t.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" alt="${t.name}">
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-text-primary truncate">${t.name}</h3>
                        <p class="text-sm text-text-secondary">${t.email}</p>
                        <div class="flex items-center flex-wrap gap-2 mt-2">
                            <span class="status-badge ${t.is_active?"status-active":"status-inactive"}">${t.is_active_text}</span>
                            ${this.getSubscriptionBadge(t)}
                            ${this.getBlacklistBadge(t,!1)}
                        </div>
                    </div>
                    <button @click="$dispatch('open-action-sheet', ${t.id})" class="p-2 text-text-secondary hover:text-text-primary -m-2"><i class="fas fa-ellipsis-v"></i></button>
                `,e.appendChild(a)}))},getSubscriptionBadge(e){if(!e.subscription_end)return`<span class="subscription-badge subscription-none"><i class="fas fa-ban"></i> ${s("subscription_none")}</span>`;const t=new Date(e.subscription_end),a=new Date,i=document.documentElement.lang==="ar"?{locale:x}:{};let r="subscription-active",n="fas fa-check-circle",o=g(t,{...i,addSuffix:!0});return b(t)?(r="subscription-expired",n="fas fa-exclamation-triangle"):w(t,{start:a,end:v(a,7)})&&(r="subscription-expired",n="fas fa-exclamation-circle"),`
                <div class="flex flex-col" title="${_(t,"PPP",i)}">
                    <span class="subscription-badge ${r}">
                        <i class="${n}"></i>
                        <span>${o}</span>
                    </span>
                </div>
            `},getBlacklistBadge(e,t=!0){return e.is_blacklisted?`<span class="blacklisted-badge"><i class="fas fa-user-slash"></i>${t?` ${s("blacklisted")}`:""}</span>`:t?`<span class="not-blacklisted">${s("not_blacklisted")}</span>`:""},openActionModal(e){const t=this.allData.find(a=>a.id===e);t&&(this.selectedUserForAction=t,this.isActionModalOpen=!0)},openActionSheet(e){const t=this.allData.find(a=>a.id===e);t&&(this.userActions=[{label:s("view_details"),icon:"fas fa-eye",classes:"hover:bg-gray-200",handler:()=>this.openUserModal(t.id)},{label:t.is_active?s("deactivate_user"):s("activate_user"),icon:"fas fa-power-off",classes:"hover:bg-gray-200",handler:()=>this.promptForStatusChange(t)},{label:t.is_blacklisted?s("unblacklist_user"):s("blacklist_user"),icon:"fas fa-user-slash",classes:"hover:bg-gray-200",handler:()=>this.promptForBlacklist(t)},{label:s("delete_user"),icon:"fas fa-trash",classes:"text-danger hover:bg-red-100",handler:()=>this.deleteUserWithConfirmation(t.id)}],this.isActionSheetOpen=!0)},async promptForStatusChange(e){var i,r;const t=e.is_active?"inactive":"active",{value:a}=await c.fire({title:s("confirm_status_change_title"),input:"textarea",inputLabel:s("reason_label"),inputPlaceholder:s("reason_placeholder"),showCancelButton:!0,confirmButtonText:s("confirm_button"),cancelButtonText:s("cancel_button"),inputValidator:n=>{if(!n)return s("reason_required")}});if(a)try{await l.put(d("api.users.update_status",{user:e.id}),{status:t,reason:a}),await this.fetchUsers(this.currentPage),c.fire({title:s("update_success_title"),text:s("update_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(n){c.fire({title:s("error_title"),text:((r=(i=n.response)==null?void 0:i.data)==null?void 0:r.message)||s("error_occurred"),icon:"error"})}},async promptForBlacklist(e){var i,r;const t=e.is_blacklisted?"unblacklist":"blacklist",{value:a}=await c.fire({title:s(`confirm_${t}_title`),input:"textarea",inputLabel:s("reason_label"),inputPlaceholder:s("reason_placeholder"),showCancelButton:!0,confirmButtonText:s("confirm_button"),cancelButtonText:s("cancel_button"),inputValidator:n=>{if(!n&&t==="blacklist")return s("reason_required")}});if(a!==void 0)try{const n=d(`api.users.${t}`,{user:e.id}),o={reason:a};t==="blacklist"?await l.post(n,o):await l.delete(n,{data:o}),await this.fetchUsers(this.currentPage),c.fire({title:s("update_success_title"),text:s("update_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(n){c.fire({title:s("error_title"),text:((r=(i=n.response)==null?void 0:i.data)==null?void 0:r.message)||s("error_occurred"),icon:"error"})}},deleteUserWithConfirmation(e){c.fire({title:s("confirm_delete_title"),text:s("confirm_delete_text"),icon:"warning",showCancelButton:!0,confirmButtonText:s("confirm_delete_button"),cancelButtonText:s("cancel_button"),confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",reverseButtons:!0}).then(t=>{t.isConfirmed&&this.deleteUser(e)})},async deleteUser(e){var t,a;try{await l.delete(d("dashboard.users.destroy",{user:e}));const i=this.allData.length===1&&this.currentPage>1?this.currentPage-1:this.currentPage;await this.fetchUsers(i),c.fire({title:s("delete_success_title"),text:s("delete_success_text"),icon:"success",timer:2e3,showConfirmButton:!1})}catch(i){c.fire({title:s("error_title"),text:((a=(t=i.response)==null?void 0:t.data)==null?void 0:a.message)||s("error_occurred"),icon:"error"})}},async openUserModal(e){this.isUserModalOpen=!0,this.selectedUser=null;try{const t=d("api.users.show",{user:e}),a=await l.get(t);this.selectedUser=a.data.data}catch{this.isUserModalOpen=!1,c.fire({icon:"error",title:s("error_title"),text:s("error_loading_user_details")})}},applyFilters(){this.fetchUsers(1)},resetFilters(){this.filters={search:"",status:"",blacklist:"",email:"",mobile:"",join_date_from:"",join_date_to:""},this.applyFilters()},updateUrlParams(){const e=new URLSearchParams(window.location.search);this.currentPage>1?e.set("page",this.currentPage):e.delete("page"),Object.entries(this.filters).forEach(([t,a])=>{a?e.set(t,a):e.delete(t)}),history.replaceState(null,"",`${window.location.pathname}?${e.toString()}`)},loadUrlParams(){const e=new URLSearchParams(window.location.search);this.currentPage=parseInt(e.get("page"))||1,Object.keys(this.filters).forEach(t=>{e.has(t)&&(this.filters[t]=e.get(t))})},setupPagination(){const e=document.getElementById("paginationControls");if(!e||!this.paginationData||!this.paginationData.links){e&&(e.innerHTML="");return}e.innerHTML="",this.paginationData.links.forEach(t=>{const a=document.createElement("button");a.innerHTML=t.label.replace("Â«",'<i class="fas fa-angle-left"></i>').replace("Â»",'<i class="fas fa-angle-right"></i>'),a.disabled=!t.url||t.active;const i="px-3 py-1.5 text-sm rounded-md border transition-colors disabled:opacity-50 disabled:cursor-not-allowed",r=t.active?"bg-accent-primary text-white border-accent-primary":"border-border-color hover:bg-page-bg";a.className=`${i} ${r}`,a.addEventListener("click",()=>{t.url&&this.fetchUsers(new URL(t.url).searchParams.get("page"))}),e.appendChild(a)})},updatePaginationInfo(){const e=document.getElementById("paginationInfo");if(!e||!this.paginationData||this.paginationData.total===0){e&&(e.innerHTML="");return}const{from:t,to:a,total:i}=this.paginationData;e.innerHTML=s("pagination_info",{from:t,to:a,total:i})}}}f.data("userManagement",y);
