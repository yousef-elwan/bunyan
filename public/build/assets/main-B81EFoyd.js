import{m as u}from"./module.esm-Cm4okMZt.js";import{g as d}from"./helpers-DwlY0Bzp.js";import{h as g}from"./api-B7h7ZzFK.js";import"./index-xsH4HHeE.js";function p(){const e=document.querySelector(".app-header"),t=e?e.offsetHeight:0,i=document.querySelector("#property-search-page .page-title-bar"),s=i?i.offsetHeight:110,a=document.documentElement;a.style.setProperty("--header-height",`${t}px`),a.style.setProperty("--top-bar-total-height",`${s}px`)}function f(){return window.innerWidth<=992}window.addEventListener("load",p);window.addEventListener("resize",()=>{clearTimeout(window.resizeTimer),window.resizeTimer=setTimeout(p,250)});const r=L.map("map",{scrollWheelZoom:!1}).setView([35,38],6);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(r);const n=L.markerClusterGroup();r.addLayer(n);function _(e=[]){n.clearLayers(),e.forEach(t=>{if(t.latitude&&t.longitude){const s=`
                <a href="${d("properties.details",{property:t.id})}" style="text-decoration:none; color:inherit;">
                    <div style="width:180px;">
                        <img src="${t.image_url}" style="width:100%; height:100px; object-fit:cover; border-radius:4px;" alt="${t.title}">
                        <div style="font-weight:bold; margin-top:5px;">
                            ${t.price_display}
                        </div>
                        <div style="font-size:12px; color:#555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${t.location}
                        </div>
                    </div>
                </a>`;n.addLayer(L.marker([t.latitude,t.longitude]).bindPopup(s))}})}function m(){if(n.getLayers().length>0){const e=n.getBounds();e.isValid()&&r.fitBounds(e,{padding:[50,50],maxZoom:14})}}function c(e,t){let i;return function(...a){const l=()=>{clearTimeout(i),e(...a)};clearTimeout(i),i=setTimeout(l,t)}}function w(){return{properties:[],pagination:null,loading:!0,loadingMore:!1,page:1,perPage:12,limitOnMap:200,showMapWarning:!1,resultCount:null,isCounting:!1,category:null,type:null,governorate:null,price_min:null,price_max:null,area_min:null,area_max:null,rooms_count:null,amenities:[],latitudeRange:null,longitudeRange:null,sortKey:"",sort:[],layout:"row",reachedEnd:!1,init(){const e=new URLSearchParams(window.location.search);this.category=e.get("category_id")||null,this.type=e.get("type_id")||null,this.governorate=e.get("city_id")||null,this.price_min=e.get("price_min")||null,this.price_max=e.get("price_max")||null,this.area_min=e.get("area_min")||null,this.area_max=e.get("area_max")||null,this.rooms_count=e.get("rooms_count")||null,this.amenities=e.get("amenities")?e.get("amenities").split(","):[],this.sortKey=e.get("sort")||"",this.layout=e.get("layout")||"row",this.checkLayoutOnResize(),this.handleLayoutChange(),this.updateSort(!1),this.fetchProperties({firstLoad:!0,resetPage:!0});const t=c(()=>this.fetchResultCount(),500);["category","type","governorate","price_min","price_max","area_min","area_max","rooms_count","amenities"].forEach(s=>{this.$watch(s,t)}),this.$watch("sortKey",()=>{this.updateSort()}),window.addEventListener("resize",c(()=>{this.checkLayoutOnResize()},250)),document.addEventListener("keydown",s=>{s.key==="Escape"&&document.body.classList.contains("no-scroll")&&this.closeSidebar()}),r.on("moveend",c(()=>{if(this.layout!=="grid"){const s=r.getBounds();this.latitudeRange=[s.getSouth(),s.getNorth()],this.longitudeRange=[s.getWest(),s.getEast()],this.fetchProperties({resetPage:!0})}},500));const i=()=>{if(this.layout!=="grid"||this.loadingMore)return;const s=document.getElementById("propertyCardsContainer");if(!s)return;s.getBoundingClientRect().bottom<=window.innerHeight+50&&(this.reachedEnd||this.loadMore())};window.addEventListener("scroll",c(i,100))},getAppliedFilters(e=!0){let t=[];return this.category&&t.push({id:"category_id",filterFns:"equals",value:this.category}),this.type&&t.push({id:"type_id",filterFns:"equals",value:this.type}),this.governorate&&t.push({id:"city_id",filterFns:"equals",value:this.governorate}),this.rooms_count&&t.push({id:"rooms_count",filterFns:"equals",value:this.rooms_count}),this.price_min&&t.push({id:"price",filterFns:"greaterThanOrEqualTo",value:this.price_min}),this.price_max&&t.push({id:"price",filterFns:"lessThanOrEqualTo",value:this.price_max}),this.area_min&&t.push({id:"size",filterFns:"greaterThanOrEqualTo",value:this.area_min}),this.area_max&&t.push({id:"size",filterFns:"lessThanOrEqualTo",value:this.area_max}),this.amenities.length>0&&t.push({id:"amenities",filterFns:"arrIncludesAll",value:JSON.stringify(this.amenities)}),e&&this.layout!=="grid"&&this.latitudeRange&&this.longitudeRange&&(t.push({id:"latitude",filterFns:"inNumberRange",value:this.latitudeRange}),t.push({id:"longitude",filterFns:"inNumberRange",value:this.longitudeRange})),t},async fetchProperties({firstLoad:e=!1,loadMore:t=!1,resetPage:i=!1,checkForUpdate:s=!1}={}){i&&(this.page=1,this.reachedEnd=!1),t||s?this.loadingMore=!0:this.loading=!0,this.setParams();const a=this.getAppliedFilters(!e),l=this.layout==="grid"?this.perPage:this.limitOnMap;try{const h=new URLSearchParams({page:this.page,perPage:l,filters:btoa(JSON.stringify(a)),sorting:btoa(JSON.stringify(this.sort))}),o=(await g().get(`${d("properties.search")}?${h}`)).data;o.data.length>0&&(t||s?this.properties.push(...o.data):this.properties=o.data),this.pagination=o.pagination,this.layout==="grid"&&this.pagination&&this.page>=this.pagination.last_page&&(this.reachedEnd=!0);const y=o.pagination.next_page_url!=null;this.showMapWarning=this.layout!=="grid"&&y,_(this.properties),e&&this.properties.length>0&&this.layout!=="grid"&&m()}catch(h){console.error("[PropertySearch] API error:",h)}finally{this.loading=!1,this.loadingMore=!1}},async fetchResultCount(){console.log("-------"),console.log("fetchResultCount"),this.isCounting=!0,this.resultCount=null;const e=this.getAppliedFilters(!1);console.log("filters",e);try{const t=new URLSearchParams({filters:btoa(JSON.stringify(e))}),i=await g().get(`${d("properties.search")}?${t}`);this.resultCount=i.data.data.length}catch(t){console.error("[FetchCount] API error:",t)}finally{this.isCounting=!1}console.log("-------")},setParams(){const e=new URL(window.location.href);e.searchParams.delete("category_id"),e.searchParams.delete("type_id"),e.searchParams.delete("city_id"),e.searchParams.delete("price_min"),e.searchParams.delete("price_max"),e.searchParams.delete("rooms_count"),e.searchParams.delete("amenities"),e.searchParams.delete("sort"),e.searchParams.delete("layout"),this.category&&e.searchParams.set("category_id",this.category),this.type&&e.searchParams.set("type_id",this.type),this.governorate&&e.searchParams.set("city_id",this.governorate),this.price_min&&e.searchParams.set("price_min",this.price_min),this.price_max&&e.searchParams.set("price_max",this.price_max),this.rooms_count&&e.searchParams.set("rooms_count",this.rooms_count),this.amenities.length&&e.searchParams.set("amenities",this.amenities.join(",")),this.sortKey&&e.searchParams.set("sort",this.sortKey),this.layout&&e.searchParams.set("layout",this.layout),window.history.replaceState({},"",e.href)},loadMore(){if(this.reachedEnd||this.pagination&&this.page>=this.pagination.last_page){this.reachedEnd=!0;return}this.page++,this.fetchProperties({loadMore:!0})},checkForUpdates(){this.pagination&&(this.page=this.pagination.last_page+1,this.fetchProperties({checkForUpdate:!0}))},updateSort(){if(this.sortKey){const t=this.sortKey.length;var e=this.sortKey.substring(0,t-4);const i=this.sortKey.substring(t-3,t);switch(console.log("this.sortKey",this.sortKey),console.log("sortKey",e),console.log("sortType",i),e){case"newest":var e="is_new";break}this.sort=[{id:e,desc:i=="des"}],this.fetchProperties({resetPage:!0})}},openSidebar(){document.getElementById("property-search-page").classList.add("sidebar-open"),document.body.classList.add("no-scroll"),this.fetchResultCount()},closeSidebar(){document.getElementById("property-search-page").classList.remove("sidebar-open"),document.body.classList.remove("no-scroll")},applyFiltersAndClose(){this.fetchProperties({resetPage:!0}),this.closeSidebar(),this.resultCount=null},checkLayoutOnResize(){f()&&this.layout==="row"&&(this.layout="grid",this.handleLayoutChange())},handleLayoutChange(){const e=document.getElementById("property-search-page"),t=document.getElementById("listingsContainer"),i=document.getElementById("mapContainer"),s=document.getElementById("propertyCardsContainer");switch(e.classList.remove("layout-row","layout-grid","layout-map"),e.classList.add(`layout-${this.layout}`),t.style.display="block",i.style.display="block",s.classList.remove("grid-view"),this.layout){case"grid":i.style.display="none",s.classList.add("grid-view"),this.latitudeRange=null,this.longitudeRange=null;break;case"map":t.style.display="none",window.innerWidth<=992&&(i.style.top=`${document.querySelector(".app-header").offsetHeight}px`,i.style.height=`calc(100vh - ${document.querySelector(".app-header").offsetHeight}px`);break;case"row":default:window.innerWidth>992&&(i.style.position="sticky",i.style.top=`${document.querySelector(".page-title-bar").offsetHeight+document.querySelector(".app-header").offsetHeight}px`,i.style.height=`calc(100vh - ${document.querySelector(".page-title-bar").offsetHeight+document.querySelector(".app-header").offsetHeight}px)`);break}this.fetchProperties({resetPage:!0}),setTimeout(()=>{r.invalidateSize(),this.layout!=="grid"&&this.properties.length>0&&m(),window.innerWidth<=992&&p()},300),this.setParams()}}}u.data("propertySearch",w);window.Alpine=u;u.start();
